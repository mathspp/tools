<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Logger</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --card-padding: clamp(1rem, 3vw, 1.5rem);
        }

        body {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px 16px 56px;
        }

        header h1 {
            margin-bottom: 0.25rem;
        }

        header .lead {
            margin-top: 0;
        }

        main {
            display: grid;
            gap: 1rem;
        }

        .surface {
            padding: var(--card-padding);
        }

        .stack {
            display: grid;
            gap: 0.75rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .status-text {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        select,
        input,
        textarea {
            width: 100%;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        .exercise-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface-2);
            overflow: hidden;
        }

        .exercise-card summary {
            padding: 0.85rem 1rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .exercise-card[open] summary {
            border-bottom: 1px solid var(--border);
            background: var(--surface-3);
        }

        .exercise-body {
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
        }

        .set-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            align-items: center;
        }

        .set-row label {
            font-weight: 600;
        }

        .set-grid {
            display: grid;
            gap: 0.5rem;
        }

        .chip-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-3);
            font-size: 0.9rem;
        }

        .exercise-meta {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .template-grid {
            display: grid;
            gap: 0.75rem;
        }

        .sticky-footer {
            position: sticky;
            bottom: 0;
            background: var(--surface-1);
            padding: 0.75rem 0;
            border-top: 1px solid var(--border);
        }

        .inline-note {
            font-size: 0.92rem;
            color: var(--text-muted);
        }

        @media (max-width: 640px) {
            .exercise-card summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }

            header h1 {
                font-size: 1.7rem;
            }
        }
    </style>
</head>

<body>
    <header class="page-header">
        <a class="site-link" href="https://tools.mathspp.com/" aria-label="Back to tools.mathspp.com">‚Üê tools.mathspp.com</a>
        <h1>Workout Logger</h1>
        <p class="lead">Fill out a workout template from the Cloudflare Worker, with autosave and last-session
            references.</p>
    </header>

    <main>
        <section class="surface stack">
            <details open>
                <summary style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0;">API settings</h2>
                        <p class="status-text" style="margin: 4px 0 0;">Store the WORKOUT_API_TOKEN used for all
                            requests.</p>
                    </div>
                </summary>
                <div class="stack" style="margin-top: 0.75rem;">
                    <label for="api-token">Bearer token</label>
                    <input id="api-token" type="password" autocomplete="off" placeholder="Paste WORKOUT_API_TOKEN">
                    <div class="controls">
                        <button type="button" id="save-token">Save</button>
                        <button type="button" id="clear-token" class="secondary">Clear</button>
                        <span class="status-text" id="settings-status" aria-live="polite"></span>
                    </div>
                </div>
            </details>
        </section>

        <section class="surface stack">
            <div class="controls" style="justify-content: space-between; align-items: center; gap: 1rem;">
                <div class="stack" style="gap: 0.35rem;">
                    <h2 style="margin: 0;">Select workout</h2>
                    <p class="status-text" id="workout-hint">Load a template to begin logging.</p>
                </div>
                <button type="button" id="refresh-templates" class="secondary">Refresh templates</button>
            </div>
            <div class="stack">
                <label for="template-select">Workout template</label>
                <select id="template-select">
                    <option value="">Choose a template‚Ä¶</option>
                </select>
            </div>
            <div class="status-text" id="template-status" aria-live="polite"></div>
        </section>

        <section class="surface stack" id="workout-panel" hidden>
            <div class="template-grid">
                <div>
                    <div class="controls" style="justify-content: space-between; align-items: center;">
                        <div>
                            <h2 id="workout-title" style="margin: 0;"></h2>
                            <p class="status-text" id="workout-summary" style="margin: 4px 0 0;"></p>
                        </div>
                        <span class="chip" id="storage-indicator">Draft saved locally</span>
                    </div>
                    <p class="status-text" id="last-session-status"></p>
                </div>

                <div id="exercise-list" class="stack"></div>

                <div class="stack">
                    <label for="overall-notes">Overall notes</label>
                    <textarea id="overall-notes" placeholder="Fatigue, sleep, aches‚Ä¶"></textarea>
                </div>
            </div>

            <div class="sticky-footer">
                <div class="controls" style="justify-content: space-between;">
                    <div class="status-text" id="save-status" aria-live="polite"></div>
                    <button type="button" id="submit-workout">Submit workout</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        (() => {
            const STORAGE_KEYS = {
                token: 'workout_api_token',
                draftPrefix: 'workout_draft_',
            };

            const WORKER_BASE = 'https://workouts-production.rodrigogiraoserrao.workers.dev';

            const state = {
                templates: [],
                selectedTemplate: null,
                latestLog: null,
                autosaveTimer: null,
                workoutStartedAt: null,
            };

            const elements = {
                tokenInput: document.getElementById('api-token'),
                saveToken: document.getElementById('save-token'),
                clearToken: document.getElementById('clear-token'),
                settingsStatus: document.getElementById('settings-status'),
                refreshTemplates: document.getElementById('refresh-templates'),
                templateSelect: document.getElementById('template-select'),
                templateStatus: document.getElementById('template-status'),
                workoutPanel: document.getElementById('workout-panel'),
                workoutTitle: document.getElementById('workout-title'),
                workoutSummary: document.getElementById('workout-summary'),
                exerciseList: document.getElementById('exercise-list'),
                workoutHint: document.getElementById('workout-hint'),
                lastSessionStatus: document.getElementById('last-session-status'),
                overallNotes: document.getElementById('overall-notes'),
                submitWorkout: document.getElementById('submit-workout'),
                saveStatus: document.getElementById('save-status'),
                storageIndicator: document.getElementById('storage-indicator'),
            };

            function loadToken() {
                const token = localStorage.getItem(STORAGE_KEYS.token) || '';
                elements.tokenInput.value = token;
                return token;
            }

            function saveToken() {
                const token = elements.tokenInput.value.trim();
                if (!token) {
                    elements.settingsStatus.textContent = 'Provide the bearer token first.';
                    return;
                }
                localStorage.setItem(STORAGE_KEYS.token, token);
                elements.settingsStatus.textContent = 'Token saved locally.';
                refreshTemplates();
            }

            function clearToken() {
                localStorage.removeItem(STORAGE_KEYS.token);
                elements.tokenInput.value = '';
                elements.settingsStatus.textContent = 'Token cleared.';
            }

            function draftKey(id) {
                return `${STORAGE_KEYS.draftPrefix}${id}`;
            }

            function setSaveStatus(message) {
                elements.saveStatus.textContent = message;
            }

            async function callApi(path, options = {}) {
                const token = localStorage.getItem(STORAGE_KEYS.token) || '';
                if (!token) {
                    throw new Error('Configure the API token first.');
                }

                const headers = new Headers(options.headers || {});
                headers.set('Content-Type', 'application/json');
                headers.set('Authorization', `Bearer ${token}`);

                const res = await fetch(`${WORKER_BASE}${path}`, {
                    ...options,
                    headers,
                });

                let data = null;
                try {
                    data = await res.json();
                } catch (error) {
                    // Ignore JSON parsing errors; handled below.
                }

                if (res.status === 401) {
                    throw new Error('Unauthorized ‚Äì check the token.');
                }

                if (!res.ok) {
                    throw new Error((data && data.error) || 'Request failed');
                }

                return data;
            }

            function templateDescription(template) {
                const setCount = template.exerciseBlocks.reduce((acc, block) => acc + block.sets, 0);
                return `${template.exerciseBlocks.length} exercises ¬∑ ${setCount} total sets`;
            }

            function populateTemplateSelect(templates) {
                elements.templateSelect.innerHTML = '<option value="">Choose a template‚Ä¶</option>';
                templates.forEach((template) => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    elements.templateSelect.appendChild(option);
                });
            }

            async function refreshTemplates() {
                elements.templateStatus.textContent = 'Loading templates‚Ä¶';
                try {
                    const data = await callApi('/api/workouts');
                    state.templates = data;
                    populateTemplateSelect(data);
                    elements.templateStatus.textContent = `${data.length} template${data.length === 1 ? '' : 's'} loaded.`;
                    elements.workoutHint.textContent = 'Choose a template to start logging.';
                } catch (error) {
                    elements.templateStatus.textContent = error.message;
                }
            }

            function getDraft(templateId) {
                const raw = localStorage.getItem(draftKey(templateId));
                if (!raw) return null;
                try {
                    return JSON.parse(raw);
                } catch (error) {
                    return null;
                }
            }

            function persistDraft(templateId, payload) {
                localStorage.setItem(draftKey(templateId), JSON.stringify(payload));
                elements.storageIndicator.textContent = 'Draft saved locally';
            }

            function clearDraft(templateId) {
                localStorage.removeItem(draftKey(templateId));
            }

            function repOptions(block) {
                if (block.amrap) return [];
                const options = [];
                const min = Number(block.repRange?.min) || 1;
                const max = Number(block.repRange?.max) || min;
                for (let i = min; i <= max; i += 1) {
                    options.push(i);
                }
                return options;
            }

            function findPreviousExercise(blockId) {
                if (!state.latestLog) return null;
                return state.latestLog.exercises.find((ex) => ex.blockId === blockId) || null;
            }

            function renderPreviousChip(block) {
                const prev = findPreviousExercise(block.id);
                if (!prev) return null;

                const firstCompleted = prev.sets.find((set) => set.weight !== null || set.reps !== null);
                if (!firstCompleted) return null;

                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.textContent = `Last: ${firstCompleted.weight ?? '‚Äî'} kg ¬∑ ${firstCompleted.reps ?? '‚Äî'} reps (RIR ${firstCompleted.rir ?? '‚Äî'})`;
                return chip;
            }

            function createAmrapInput(blockId, setIndex, initialValue) {
                const input = document.createElement('input');
                input.type = 'number';
                input.inputMode = 'numeric';
                input.min = '1';
                input.step = '1';
                input.placeholder = 'Reps (AMRAP)';
                input.dataset.blockId = blockId;
                input.dataset.setIndex = setIndex;
                input.dataset.field = 'reps';

                if (Number.isInteger(initialValue)) {
                    input.value = initialValue;
                }

                input.addEventListener('input', () => {
                    if (input.value === '') {
                        input.setCustomValidity('');
                        return;
                    }

                    const parsed = Number.parseInt(input.value, 10);
                    if (Number.isNaN(parsed)) {
                        input.setCustomValidity('Enter a whole number');
                    } else {
                        input.value = parsed;
                        input.setCustomValidity('');
                    }
                });

                return input;
            }

            function createSetRow(blockId, setIndex, block, draft) {
                const row = document.createElement('div');
                row.className = 'set-row';

                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.inputMode = 'decimal';
                weightInput.step = '0.5';
                weightInput.placeholder = 'Weight';
                weightInput.dataset.blockId = blockId;
                weightInput.dataset.setIndex = setIndex;
                weightInput.dataset.field = 'weight';

                const rirSelect = document.createElement('select');
                rirSelect.dataset.blockId = blockId;
                rirSelect.dataset.setIndex = setIndex;
                rirSelect.dataset.field = 'rir';
                const rirPlaceholder = document.createElement('option');
                rirPlaceholder.value = '';
                rirPlaceholder.textContent = 'RIR';
                rirSelect.appendChild(rirPlaceholder);
                for (let i = 0; i <= 5; i += 1) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    rirSelect.appendChild(option);
                }

                const prev = findPreviousExercise(blockId);
                const prevSet = prev && prev.sets[setIndex];
                const draftExercise = draft?.exercises?.find((ex) => ex.blockId === blockId);
                const draftSet = draftExercise?.sets?.[setIndex];

                let repsField = null;
                if (block.amrap) {
                    const initial = draftSet?.reps ?? prevSet?.reps;
                    repsField = createAmrapInput(blockId, setIndex, initial);
                } else {
                    const repsSelect = document.createElement('select');
                    repsSelect.dataset.blockId = blockId;
                    repsSelect.dataset.setIndex = setIndex;
                    repsSelect.dataset.field = 'reps';
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Reps';
                    repsSelect.appendChild(placeholder);
                    repOptions(block).forEach((rep) => {
                        const option = document.createElement('option');
                        option.value = rep;
                        option.textContent = rep;
                        repsSelect.appendChild(option);
                    });
                    repsField = repsSelect;
                }

                if (draftSet) {
                    weightInput.value = draftSet.weight ?? '';
                    if (!block.amrap) {
                        repsField.value = draftSet.reps ?? '';
                    } else if (Number.isInteger(draftSet.reps)) {
                        repsField.value = draftSet.reps;
                    }
                    rirSelect.value = draftSet.rir ?? '';
                } else if (prevSet) {
                    weightInput.value = prevSet.weight ?? '';
                    if (!block.amrap) {
                        repsField.value = prevSet.reps ?? '';
                    } else if (Number.isInteger(prevSet.reps)) {
                        repsField.value = prevSet.reps;
                    }
                    rirSelect.value = prevSet.rir ?? '';
                }

                row.appendChild(weightInput);
                row.appendChild(repsField);
                row.appendChild(rirSelect);
                return row;
            }

            function createExerciseBlock(block, draft) {
                const details = document.createElement('details');
                details.className = 'exercise-card';
                details.open = true;

                const summary = document.createElement('summary');
                const repLabel = block.amrap ? 'AMRAP' : `${block.repRange?.min ?? '‚Äî'}-${block.repRange?.max ?? '‚Äî'} reps`;
                summary.innerHTML = `<span>${block.name}</span><span class="exercise-meta">${block.sets} sets ¬∑ ${repLabel}</span>`;

                const body = document.createElement('div');
                body.className = 'exercise-body';

                const notes = document.createElement('p');
                notes.className = 'exercise-meta';
                notes.textContent = block.notes || 'No template notes.';
                body.appendChild(notes);

                const chip = renderPreviousChip(block);
                if (chip) {
                    const chipRow = document.createElement('div');
                    chipRow.className = 'chip-row';
                    chipRow.appendChild(chip);
                    body.appendChild(chipRow);
                }

                const setGrid = document.createElement('div');
                setGrid.className = 'set-grid';

                for (let i = 0; i < block.sets; i += 1) {
                    const label = document.createElement('label');
                    label.textContent = `Set ${i + 1}`;
                    const row = createSetRow(block.id, i, block, draft);
                    const wrapper = document.createElement('div');
                    wrapper.className = 'stack';
                    wrapper.appendChild(label);
                    wrapper.appendChild(row);
                    setGrid.appendChild(wrapper);
                }

                const progressionWrapper = document.createElement('div');
                progressionWrapper.className = 'stack';
                const progressionLabel = document.createElement('label');
                progressionLabel.textContent = 'Progression notes';
                progressionLabel.setAttribute('for', `progression-${block.id}`);
                const progressionInput = document.createElement('textarea');
                progressionInput.id = `progression-${block.id}`;
                progressionInput.dataset.blockId = block.id;
                progressionInput.dataset.field = 'progression';
                progressionInput.placeholder = 'E.g. add 2.5 kg next week, or push for top-end reps.';

                const draftExercise = draft?.exercises?.find((ex) => ex.blockId === block.id);
                const prev = findPreviousExercise(block.id);
                if (draftExercise?.progressionNotes) {
                    progressionInput.value = draftExercise.progressionNotes;
                } else if (prev?.progressionNotes) {
                    progressionInput.value = prev.progressionNotes;
                }

                progressionWrapper.appendChild(progressionLabel);
                progressionWrapper.appendChild(progressionInput);

                body.appendChild(setGrid);
                body.appendChild(progressionWrapper);

                details.appendChild(summary);
                details.appendChild(body);
                return details;
            }

            function loadDraftIntoUI(template, draft) {
                elements.overallNotes.value = draft?.overallNotes || '';
                elements.exerciseList.innerHTML = '';
                template.exerciseBlocks.forEach((block) => {
                    const blockEl = createExerciseBlock(block, draft);
                    elements.exerciseList.appendChild(blockEl);
                });
            }

            function buildCurrentPayload() {
                if (!state.selectedTemplate) return null;
                const exercises = state.selectedTemplate.exerciseBlocks.map((block) => {
                    const sets = [];
                    for (let i = 0; i < block.sets; i += 1) {
                        const weight = document.querySelector(`input[data-block-id="${block.id}"][data-set-index="${i}"][data-field="weight"]`);
                        const reps = document.querySelector(`[data-block-id="${block.id}"][data-set-index="${i}"][data-field="reps"]`);
                        const rir = document.querySelector(`select[data-block-id="${block.id}"][data-set-index="${i}"][data-field="rir"]`);
                        sets.push({
                            weight: weight?.value ? Number(weight.value) : null,
                            reps: reps?.value ? Number.parseInt(reps.value, 10) : null,
                            rir: rir?.value ? Number(rir.value) : null,
                        });
                    }
                    const progressionNotes = document.querySelector(`textarea[data-block-id="${block.id}"][data-field="progression"]`)?.value || '';
                    return {
                        blockId: block.id,
                        sets,
                        progressionNotes,
                    };
                });

                return {
                    startedAt: state.workoutStartedAt,
                    finishedAt: new Date().toISOString(),
                    exercises,
                    overallNotes: elements.overallNotes.value || '',
                };
            }

            function scheduleDraftSave() {
                if (!state.selectedTemplate) return;
                window.clearTimeout(state.autosaveTimer);
                state.autosaveTimer = window.setTimeout(() => {
                    const payload = buildCurrentPayload();
                    if (payload) {
                        persistDraft(state.selectedTemplate.id, payload);
                        setSaveStatus('Saved locally.');
                    }
                }, 350);
            }

            async function handleTemplateChange() {
                const id = elements.templateSelect.value;
                state.latestLog = null;
                if (!id) {
                    state.selectedTemplate = null;
                    elements.workoutPanel.hidden = true;
                    return;
                }

                const template = state.templates.find((t) => t.id === id);
                state.selectedTemplate = template;
                state.workoutStartedAt = new Date().toISOString();
                elements.workoutTitle.textContent = template.name;
                elements.workoutSummary.textContent = templateDescription(template);
                elements.workoutPanel.hidden = false;
                elements.saveStatus.textContent = '';
                elements.storageIndicator.textContent = 'Draft saved locally';
                elements.lastSessionStatus.textContent = 'Fetching last session‚Ä¶';

                try {
                    const latest = await callApi(`/api/workouts/${encodeURIComponent(id)}/logs/latest`);
                    state.latestLog = latest?.log || null;
                    if (state.latestLog) {
                        const finished = new Date(state.latestLog.finishedAt).toLocaleString();
                        elements.lastSessionStatus.textContent = `Last session: ${finished}. Prefilled with previous numbers.`;
                    } else {
                        elements.lastSessionStatus.textContent = 'No previous sessions logged yet.';
                    }
                } catch (error) {
                    elements.lastSessionStatus.textContent = `Could not load last session: ${error.message}`;
                }

                const draft = getDraft(id);
                loadDraftIntoUI(template, draft || state.latestLog);
                scheduleDraftSave();
            }

            async function submitWorkout() {
                if (!state.selectedTemplate) return;
                setSaveStatus('Submitting‚Ä¶');
                const payload = buildCurrentPayload();
                if (!payload) return;

                try {
                    await callApi(`/api/workouts/${encodeURIComponent(state.selectedTemplate.id)}/logs`, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                    });
                    clearDraft(state.selectedTemplate.id);
                    setSaveStatus('Workout submitted and stored. Draft cleared.');
                } catch (error) {
                    setSaveStatus(`Submit failed: ${error.message}`);
                }
            }

            function bindEvents() {
                elements.saveToken.addEventListener('click', saveToken);
                elements.clearToken.addEventListener('click', clearToken);
                elements.refreshTemplates.addEventListener('click', refreshTemplates);
                elements.templateSelect.addEventListener('change', handleTemplateChange);
                elements.submitWorkout.addEventListener('click', submitWorkout);
                elements.workoutPanel.addEventListener('input', scheduleDraftSave, true);
                elements.workoutPanel.addEventListener('change', scheduleDraftSave, true);
            }

            function init() {
                loadToken();
                bindEvents();
                refreshTemplates();
            }

            init();
        })();
    </script>

    <footer class="page-footer">
        <p>Built with ‚ù§Ô∏è, ü§ñ, and üêç, by <a href="https://mathspp.com/">Rodrigo Gir√£o Serr√£o</a></p>
    </footer>
</body>

</html>
