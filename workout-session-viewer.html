<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Session Viewer</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --card-padding: clamp(1rem, 3vw, 1.5rem);
        }

        body {
            max-width: 1100px;
            margin: 0 auto;
            padding: clamp(1.5rem, 3vw, 2.5rem) clamp(1rem, 3vw, 2rem) clamp(3rem, 5vw, 4rem);
        }

        header h1 {
            margin-bottom: 0.35rem;
        }

        header .lead {
            margin-top: 0;
        }

        main {
            display: grid;
            gap: 1.25rem;
        }

        .surface {
            padding: var(--card-padding);
        }

        .stack {
            display: grid;
            gap: 0.75rem;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .status-text {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        label + select,
        label + input {
            width: 100%;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .nav-buttons {
            display: inline-flex;
            gap: 0.35rem;
        }

        .record-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem 1.25rem;
            align-items: center;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-3);
            font-size: 0.92rem;
        }

        .exercise-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface-2);
            padding: 1rem;
            display: grid;
            gap: 0.65rem;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .exercise-name {
            font-size: 1.05rem;
            font-weight: 700;
            margin: 0;
        }

        .set-grid {
            display: grid;
            gap: 0.5rem;
        }

        .set-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.4rem;
            align-items: center;
        }

        .set-label {
            font-weight: 700;
        }

        .delta {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--surface-3);
            font-weight: 700;
            font-size: 0.92rem;
        }

        .delta.positive {
            color: var(--gr);
        }

        .delta.negative {
            color: var(--re);
        }

        .delta.neutral {
            color: var(--text-muted);
        }

        .notes {
            margin: 0;
            color: var(--text-muted);
        }

        .empty-state {
            padding: 0.85rem 1rem;
            border-radius: 10px;
            border: 1px dashed var(--border);
            background: var(--surface-2);
        }

        .comparison-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .workout-links {
            border: 1px solid var(--border);
            background: var(--surface-1);
        }

        .link-grid {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .link-card {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            padding: 0.65rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface-2);
            text-decoration: none;
            font-weight: 600;
        }

        .link-card:hover { border-color: var(--accent); }

        @media (max-width: 720px) {
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .record-meta {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <header class="page-header">
        <a class="site-link" href="https://tools.mathspp.com/" aria-label="Back to tools.mathspp.com">‚Üê tools.mathspp.com</a>
        <h1>Workout Session Viewer</h1>
        <p class="lead">Browse past sessions for a template, move through them one by one, and compare sets side by side.</p>
    </header>

    <main>
        <section class="surface stack">
            <h2 style="margin: 0;">API configuration</h2>
            <p class="status-text">Set the API base URL and bearer token once in <a href="workout-settings.html">Workout settings</a>. Stored values are reused automatically.</p>
        </section>

        <section class="surface stack">
            <div class="controls" style="justify-content: space-between; align-items: center; gap: 1rem;">
                <div class="stack" style="gap: 0.35rem;">
                    <h2 style="margin: 0;">Select template</h2>
                    <p class="status-text" id="template-status">Choose a workout template to view its history.</p>
                </div>
                <button type="button" id="refresh-templates" class="secondary">Refresh templates</button>
            </div>
            <label class="sr-only" for="template-select">Workout template</label>
            <select id="template-select" aria-label="Workout template">
                <option value="" disabled selected>Pick a template‚Ä¶</option>
            </select>
        </section>

        <section class="surface stack" id="history-panel" hidden>
            <div class="panel-header">
                <div class="stack" style="gap: 0.25rem;">
                    <h2 style="margin: 0;">Template history</h2>
                    <p class="status-text" id="record-status">Loading records‚Ä¶</p>
                </div>
                <div class="nav-buttons" aria-label="Record navigation">
                    <button type="button" id="previous-record" class="secondary" aria-label="Previous record">‚Üê</button>
                    <button type="button" id="next-record" class="secondary" aria-label="Next record">‚Üí</button>
                </div>
            </div>

            <div class="comparison-controls">
                <div class="stack" style="flex: 1; min-width: 240px;">
                    <label for="compare-select">Compare with</label>
                    <select id="compare-select" aria-label="Comparison record">
                        <option value="">No comparison</option>
                    </select>
                </div>
                <div class="status-text" id="comparison-hint" aria-live="polite"></div>
            </div>

            <div id="record-container" class="stack"></div>
        </section>

        <section class="surface stack workout-links" aria-label="Workout tools navigation">
            <h2 style="margin: 0;">Workout tools</h2>
            <p class="status-text">Quick links to the rest of the workout suite.</p>
            <div class="link-grid">
                <a class="link-card" href="workout-settings.html">Workout settings<span>‚Üí</span></a>
                <a class="link-card" href="workout-template-manager.html">Workout template manager<span>‚Üí</span></a>
                <a class="link-card" href="workout-session-logger.html">Workout session logger<span>‚Üí</span></a>
                <a class="link-card" href="workout-session-viewer.html">Workout session viewer<span>‚Üí</span></a>
                <a class="link-card" href="workout-exercise-manager.html">Workout exercise manager<span>‚Üí</span></a>
                <a class="link-card" href="workout-exercise-record.html">Workout exercise records<span>‚Üí</span></a>
            </div>
        </section>
    </main>

    <script>
        (() => {
            const STORAGE_KEYS = {
                token: 'workout-api-token',
                base: 'workout-api-base',
            };

            const state = {
                templates: [],
                sessions: [],
                currentIndex: 0,
                comparisonId: '',
            };

            const elements = {
                refreshTemplates: document.getElementById('refresh-templates'),
                templateSelect: document.getElementById('template-select'),
                templateStatus: document.getElementById('template-status'),
                historyPanel: document.getElementById('history-panel'),
                recordStatus: document.getElementById('record-status'),
                recordContainer: document.getElementById('record-container'),
                prevRecord: document.getElementById('previous-record'),
                nextRecord: document.getElementById('next-record'),
                compareSelect: document.getElementById('compare-select'),
                comparisonHint: document.getElementById('comparison-hint'),
            };

            function getConfig() {
                const base = (localStorage.getItem(STORAGE_KEYS.base) || '').trim();
                const token = (localStorage.getItem(STORAGE_KEYS.token) || '').trim();
                if (!base || !token) {
                    throw new Error('Set the API base URL and bearer token in Workout settings first.');
                }
                return { base, token };
            }

            async function callApi(path, options = {}) {
                const { base, token } = getConfig();

                const headers = new Headers(options.headers || {});
                headers.set('Content-Type', 'application/json');
                headers.set('Authorization', `Bearer ${token}`);

                const url = `${base.replace(/\/$/, '')}${path}`;
                const res = await fetch(url, {
                    ...options,
                    headers,
                });

                let data = null;
                try {
                    data = await res.json();
                } catch (error) {
                    // handled by status check below
                }

                if (res.status === 401) {
                    throw new Error('Unauthorized ‚Äì check the token.');
                }

                if (!res.ok) {
                    const message = data?.error?.message || data?.error || data?.message || 'Request failed';
                    throw new Error(message);
                }

                return data;
            }

            function formatDate(value) {
                if (!value) return 'Unknown date';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }
                return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            }

            function formatTimestamp(value) {
                if (!value) return 'Unknown time';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            }

            function formatWeight(value) {
                return Number.isFinite(value) ? `${value} kg` : '‚Äî';
            }

            function formatReps(value) {
                return Number.isFinite(value) ? `${value} reps` : '‚Äî';
            }

            function formatReserve(value) {
                if (!Number.isFinite(value)) return '';
                return `${value} RIR`;
            }

            function prettifyName(name) {
                if (!name) return 'Exercise';
                return name.replace(/[_-]+/g, ' ').replace(/\b\w/g, (m) => m.toUpperCase());
            }

            function diffDisplay(current, previous, unit) {
                const wrapper = document.createElement('span');
                wrapper.className = 'delta neutral';
                wrapper.textContent = '‚Äî';

                if (!Number.isFinite(current) || !Number.isFinite(previous)) {
                    return wrapper;
                }

                const diff = current - previous;
                const indicator = diff > 0 ? '‚ñ≤' : diff < 0 ? '‚ñº' : '‚Äî';
                const absValue = Math.abs(diff);

                wrapper.textContent = `${indicator} ${absValue}${unit}`;

                if (diff > 0) {
                    wrapper.className = 'delta positive';
                } else if (diff < 0) {
                    wrapper.className = 'delta negative';
                }

                if (diff === 0) {
                    wrapper.textContent = '‚Äî';
                }

                return wrapper;
            }

            function buildComparisonMap(session) {
                const map = new Map();
                if (!session) return map;

                (session.exercise_blocks || []).forEach((block, index) => {
                    const key = `${block.exercise_name || 'exercise'}:${index}`;
                    map.set(key, block.sets || []);
                });
                return map;
            }

            function renderExercise(block, index, comparisonMap) {
                const card = document.createElement('article');
                card.className = 'exercise-card';

                const header = document.createElement('div');
                header.className = 'exercise-header';

                const name = document.createElement('p');
                name.className = 'exercise-name';
                name.textContent = prettifyName(block.exercise_name) || 'Exercise';

                header.appendChild(name);

                if (Number.isFinite(block.rpe_reserve)) {
                    const reserve = document.createElement('span');
                    reserve.className = 'chip';
                    reserve.textContent = `Reserve: ${formatReserve(block.rpe_reserve)}`;
                    header.appendChild(reserve);
                }

                card.appendChild(header);

                const setGrid = document.createElement('div');
                setGrid.className = 'set-grid';

                const comparisonSets = comparisonMap.get(`${block.exercise_name || 'exercise'}:${index}`) || [];

                (block.sets || []).forEach((set, setIndex) => {
                    const row = document.createElement('div');
                    row.className = 'set-row';

                    const label = document.createElement('div');
                    label.className = 'set-label';
                    label.textContent = `Set ${setIndex + 1}`;
                    row.appendChild(label);

                    const weightCell = document.createElement('div');
                    weightCell.innerHTML = `<strong>Weight:</strong> ${formatWeight(set.weight)}`;
                    const weightComparison = diffDisplay(set.weight, comparisonSets[setIndex]?.weight, 'kg');
                    weightComparison.setAttribute('aria-label', 'Weight difference');
                    weightCell.appendChild(document.createTextNode(' '));
                    weightCell.appendChild(weightComparison);
                    row.appendChild(weightCell);

                    const repsCell = document.createElement('div');
                    repsCell.innerHTML = `<strong>Reps:</strong> ${formatReps(set.reps)}`;
                    const repsComparison = diffDisplay(set.reps, comparisonSets[setIndex]?.reps, '');
                    repsComparison.setAttribute('aria-label', 'Reps difference');
                    repsCell.appendChild(document.createTextNode(' '));
                    repsCell.appendChild(repsComparison);
                    row.appendChild(repsCell);

                    if (set.notes) {
                        const notes = document.createElement('div');
                        notes.className = 'notes';
                        notes.textContent = set.notes;
                        row.appendChild(notes);
                    }

                    setGrid.appendChild(row);
                });

                if (block.notes) {
                    const notes = document.createElement('p');
                    notes.className = 'notes';
                    notes.textContent = block.notes;
                    card.appendChild(notes);
                }

                card.appendChild(setGrid);
                return card;
            }

            function renderSession(session) {
                elements.recordContainer.innerHTML = '';

                if (!session) {
                    elements.recordContainer.innerHTML = '<div class="empty-state">No sessions to show yet.</div>';
                    return;
                }

                const comparisonSession = state.sessions.find((entry) => entry.id === state.comparisonId) || null;
                const comparisonMap = buildComparisonMap(comparisonSession);

                const meta = document.createElement('div');
                meta.className = 'record-meta';

                const sessionDate = document.createElement('span');
                sessionDate.className = 'chip';
                sessionDate.textContent = `Date: ${formatDate(session.date)}`;
                meta.appendChild(sessionDate);

                const createdChip = document.createElement('span');
                createdChip.className = 'chip';
                createdChip.textContent = `Logged: ${formatTimestamp(session.created_at)}`;
                meta.appendChild(createdChip);

                const countChip = document.createElement('span');
                countChip.className = 'chip';
                countChip.textContent = `Record ${state.currentIndex + 1} of ${state.sessions.length}`;
                meta.appendChild(countChip);

                elements.recordContainer.appendChild(meta);

                if (session.notes) {
                    const notes = document.createElement('p');
                    notes.className = 'notes';
                    notes.textContent = `Session notes: ${session.notes}`;
                    elements.recordContainer.appendChild(notes);
                }

                (session.exercise_blocks || []).forEach((block, index) => {
                    elements.recordContainer.appendChild(renderExercise(block, index, comparisonMap));
                });

                if (state.comparisonId) {
                    elements.comparisonHint.textContent = 'Showing differences against the selected record.';
                } else {
                    elements.comparisonHint.textContent = 'Select another session to compare weights and reps.';
                }
            }

            function updateComparisonOptions() {
                elements.compareSelect.innerHTML = '<option value="">No comparison</option>';
                state.sessions.forEach((session, idx) => {
                    if (idx === state.currentIndex) return;
                    const option = document.createElement('option');
                    option.value = session.id;
                    option.textContent = `${formatDate(session.date)} ‚Ä¢ ${formatTimestamp(session.created_at)}`;
                    elements.compareSelect.appendChild(option);
                });
                elements.compareSelect.value = state.comparisonId;
            }

            function handleNavigation(direction) {
                const nextIndex = state.currentIndex + direction;
                if (nextIndex < 0 || nextIndex >= state.sessions.length) return;
                state.currentIndex = nextIndex;
                state.comparisonId = '';
                updateComparisonOptions();
                renderSession(state.sessions[state.currentIndex]);
                elements.prevRecord.disabled = state.currentIndex === state.sessions.length - 1;
                elements.nextRecord.disabled = state.currentIndex === 0;
                elements.recordStatus.textContent = `Showing ${formatDate(state.sessions[state.currentIndex].date)}`;
            }

            async function refreshTemplates() {
                elements.templateStatus.textContent = 'Loading templates‚Ä¶';
                elements.templateSelect.disabled = true;
                elements.templateSelect.innerHTML = '<option value="" disabled selected>Pick a template‚Ä¶</option>';

                try {
                    const data = await callApi('/templates');
                    state.templates = Array.isArray(data?.templates) ? data.templates : [];

                    if (state.templates.length === 0) {
                        elements.templateStatus.textContent = 'No templates found.';
                        return;
                    }

                    state.templates
                        .sort((a, b) => a.localeCompare(b))
                        .forEach((template) => {
                            const option = document.createElement('option');
                            option.value = template;
                            option.textContent = template;
                            elements.templateSelect.appendChild(option);
                        });

                    elements.templateStatus.textContent = 'Templates loaded.';
                } catch (error) {
                    elements.templateStatus.textContent = error.message;
                } finally {
                    elements.templateSelect.disabled = false;
                }
            }

            async function loadSessionsForTemplate(id) {
                elements.recordContainer.innerHTML = '';
                elements.recordStatus.textContent = 'Loading records‚Ä¶';
                elements.historyPanel.hidden = false;
                elements.prevRecord.disabled = true;
                elements.nextRecord.disabled = true;
                elements.compareSelect.innerHTML = '<option value="">No comparison</option>';
                state.sessions = [];
                state.currentIndex = 0;
                state.comparisonId = '';

                try {
                    const data = await callApi(`/templates/${encodeURIComponent(id)}/sessions?limit=500&offset=0`);
                    state.sessions = Array.isArray(data?.sessions) ? data.sessions : [];

                    if (state.sessions.length === 0) {
                        elements.recordStatus.textContent = 'No records found for this template yet.';
                        elements.recordContainer.innerHTML = '<div class="empty-state">Log a workout to see it here.</div>';
                        return;
                    }

                    state.currentIndex = 0;
                    elements.prevRecord.disabled = state.sessions.length <= 1;
                    elements.nextRecord.disabled = true;

                    updateComparisonOptions();
                    renderSession(state.sessions[state.currentIndex]);
                    elements.recordStatus.textContent = `Showing ${formatDate(state.sessions[state.currentIndex].date)}`;
                } catch (error) {
                    elements.recordStatus.textContent = error.message;
                    elements.recordContainer.innerHTML = '<div class="empty-state">Could not load records.</div>';
                }
            }

            function init() {
                elements.refreshTemplates.addEventListener('click', refreshTemplates);

                elements.templateSelect.addEventListener('change', (event) => {
                    const id = event.target.value;
                    if (!id) return;
                    elements.templateStatus.textContent = `Viewing logs for ${id}.`;
                    loadSessionsForTemplate(id);
                });

                elements.prevRecord.addEventListener('click', () => handleNavigation(1));
                elements.nextRecord.addEventListener('click', () => handleNavigation(-1));

                elements.compareSelect.addEventListener('change', (event) => {
                    state.comparisonId = event.target.value;
                    renderSession(state.sessions[state.currentIndex]);
                    if (state.comparisonId) {
                        elements.comparisonHint.textContent = 'Showing differences against the selected record.';
                    } else {
                        elements.comparisonHint.textContent = 'Select another session to compare weights and reps.';
                    }
                });

                refreshTemplates();
            }

            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>

    <footer class="page-footer">
        <p>Built with ‚ù§Ô∏è, ü§ñ, and üêç, by <a href="https://mathspp.com/">Rodrigo Gir√£o Serr√£o</a></p>
    </footer>
</body>

</html>
