<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Manager</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px 20px 64px;
        }

        main {
            display: grid;
            gap: 1.25rem;
        }

        .split {
            display: grid;
            gap: 1rem;
        }

        .tool-card {
            padding: clamp(1.25rem, 3vw, 2rem);
        }

        .stack {
            display: grid;
            gap: 0.75rem;
        }

        .workout-list {
            display: grid;
            gap: 0.5rem;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .workout-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            background: var(--surface-2);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .workout-item span {
            font-weight: 600;
        }

        .status {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .exercise-block {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            background: var(--surface-2);
            display: grid;
            gap: 0.75rem;
        }

        .exercise-block header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .exercise-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem 1rem;
        }

        .notes-input {
            width: 100%;
            min-height: 60px;
        }

        .exercise-summary {
            display: grid;
            gap: 0.5rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--surface-3);
            border: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .pill-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .empty-state {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: 1px dashed var(--border);
            background: var(--surface-2);
        }

        @media (min-width: 900px) {
            .split {
                grid-template-columns: 1.1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Workout Manager</h1>
        <p class="lead">Manage workout templates stored in the Cloudflare Worker: list, inspect, delete, and create
            templates from a single page.</p>
    </header>

    <main>
        <section class="surface tool-card stack" id="settings">
            <h2>API settings</h2>
            <p class="status">Provide your Worker base URL and bearer token. These are stored locally in your browser.</p>
            <div class="split">
                <div class="form-group">
                    <label for="api-base">Worker base URL</label>
                    <input id="api-base" type="url" name="api-base" placeholder="https://your-worker.workers.dev">
                    <p class="form-hint">Requests are sent to <code>&lt;base&gt;/api/workouts</code>.</p>
                </div>
                <div class="form-group">
                    <label for="api-token">Bearer token</label>
                    <input id="api-token" type="password" name="api-token" autocomplete="off"
                        placeholder="Paste WORKOUT_API_TOKEN">
                </div>
            </div>
            <div class="tool-actions">
                <button id="save-settings" type="button">Save settings</button>
                <button id="clear-settings" type="button" class="secondary">Clear</button>
            </div>
        </section>

        <section class="surface tool-card stack" id="workouts">
            <div class="split" style="align-items: center;">
                <div>
                    <h2>Workout templates</h2>
                    <p class="status">Select a template to view its exercises and estimated duration.</p>
                </div>
                <div class="tool-actions" style="justify-content: flex-end;">
                    <button id="refresh-workouts" type="button">Refresh list</button>
                </div>
            </div>
            <ul class="workout-list" id="workout-list"></ul>
            <div class="empty-state" id="workout-empty" hidden>No templates found. Create your first template below.</div>
        </section>

        <section class="surface tool-card stack" id="workout-detail">
            <div class="split" style="align-items: center;">
                <div>
                    <h2>Workout detail</h2>
                    <p class="status" id="detail-status">Select a workout to see its exercises.</p>
                </div>
                <div class="tool-actions" style="justify-content: flex-end;">
                    <button id="delete-workout" type="button" class="danger" disabled>Delete workout</button>
                </div>
            </div>
            <div id="workout-content" class="exercise-summary"></div>
        </section>

        <section class="surface tool-card stack" id="create-workout">
            <h2>Create a new workout template</h2>
            <p class="status">Start with three empty exercises. Reorder them, add more, then create the template.</p>
            <div class="form-group">
                <label for="workout-name">Workout name</label>
                <input id="workout-name" name="workout-name" type="text" placeholder="e.g. Push A" required>
            </div>
            <div class="tool-actions">
                <button id="add-exercise" type="button" class="secondary">Add exercise block</button>
            </div>
            <div class="stack" id="exercise-blocks"></div>
            <div class="tool-actions">
                <button id="create-workout-btn" type="button">Create</button>
            </div>
            <div id="create-status" class="status" aria-live="polite"></div>
        </section>
    </main>

    <script>
        (function () {
            const STORAGE_KEYS = {
                apiBase: 'workouts_api_base',
                token: 'workout_api_token',
            };

            const DEFAULT_EXERCISE_COUNT = 3;
            const REST_BETWEEN_EXERCISES = 180; // seconds
            const SET_DURATION = 45; // seconds
            const REST_BETWEEN_SETS = 90; // seconds

            const apiBaseInput = document.getElementById('api-base');
            const tokenInput = document.getElementById('api-token');
            const saveSettingsBtn = document.getElementById('save-settings');
            const clearSettingsBtn = document.getElementById('clear-settings');
            const refreshBtn = document.getElementById('refresh-workouts');
            const workoutList = document.getElementById('workout-list');
            const workoutEmpty = document.getElementById('workout-empty');
            const workoutContent = document.getElementById('workout-content');
            const detailStatus = document.getElementById('detail-status');
            const deleteBtn = document.getElementById('delete-workout');
            const workoutNameInput = document.getElementById('workout-name');
            const addExerciseBtn = document.getElementById('add-exercise');
            const exerciseBlocksContainer = document.getElementById('exercise-blocks');
            const createBtn = document.getElementById('create-workout-btn');
            const createStatus = document.getElementById('create-status');

            let selectedWorkoutId = null;

            function loadSettings() {
                const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || '';
                const token = localStorage.getItem(STORAGE_KEYS.token) || '';
                apiBaseInput.value = apiBase;
                tokenInput.value = token;
            }

            function saveSettings() {
                const base = (apiBaseInput.value || '').trim().replace(/\/$/, '');
                const token = tokenInput.value.trim();
                if (!base) {
                    alert('Please provide a Worker base URL.');
                    return;
                }
                if (!token) {
                    alert('Please provide the bearer token.');
                    return;
                }
                localStorage.setItem(STORAGE_KEYS.apiBase, base);
                localStorage.setItem(STORAGE_KEYS.token, token);
                detailStatus.textContent = 'Settings saved. You can now load workouts.';
            }

            function clearSettings() {
                localStorage.removeItem(STORAGE_KEYS.apiBase);
                localStorage.removeItem(STORAGE_KEYS.token);
                apiBaseInput.value = '';
                tokenInput.value = '';
                detailStatus.textContent = 'Cleared saved settings.';
            }

            async function callApi(path, options = {}) {
                const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || '';
                const token = localStorage.getItem(STORAGE_KEYS.token) || '';
                if (!apiBase || !token) {
                    throw new Error('Configure API base URL and token first.');
                }

                const headers = new Headers(options.headers || {});
                headers.set('Content-Type', 'application/json');
                headers.set('Authorization', `Bearer ${token}`);

                const response = await fetch(`${apiBase}${path}`, {
                    ...options,
                    headers,
                });

                if (response.status === 401) {
                    throw new Error('Unauthorized – check your token.');
                }

                const data = await response.json();
                if (!response.ok) {
                    const message = data && data.error ? data.error : 'Request failed';
                    throw new Error(message);
                }

                return data;
            }

            function formatSeconds(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                if (mins <= 0) return `${secs}s`;
                return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;
            }

            function estimateExerciseSeconds(sets) {
                if (!Number.isFinite(sets) || sets <= 0) return 0;
                const work = sets * SET_DURATION;
                const rest = Math.max(sets - 1, 0) * REST_BETWEEN_SETS;
                return work + rest;
            }

            function renderWorkoutList(items) {
                workoutList.innerHTML = '';
                if (!items.length) {
                    workoutEmpty.hidden = false;
                    return;
                }
                workoutEmpty.hidden = true;

                items.forEach((workout) => {
                    const li = document.createElement('li');
                    li.className = 'workout-item';
                    li.innerHTML = `
                        <span>${workout.name}</span>
                        <div class="tool-actions">
                            <button type="button" data-action="view">View</button>
                        </div>
                    `;
                    li.querySelector('[data-action="view"]').addEventListener('click', () => loadWorkout(workout.id));
                    workoutList.appendChild(li);
                });
            }

            async function loadWorkouts() {
                detailStatus.textContent = 'Loading workouts…';
                workoutContent.innerHTML = '';
                deleteBtn.disabled = true;
                try {
                    const workouts = await callApi('/api/workouts', { method: 'GET' });
                    renderWorkoutList(workouts);
                    detailStatus.textContent = 'Select a workout to see its details.';
                } catch (error) {
                    detailStatus.textContent = error.message;
                }
            }

            function renderWorkoutDetail(workout) {
                selectedWorkoutId = workout.id;
                deleteBtn.disabled = false;
                const exercises = workout.exerciseBlocks || [];
                const totalExerciseSeconds = exercises.reduce((total, block) => total + estimateExerciseSeconds(Number(block.sets)), 0);
                const totalRestBetweenExercises = Math.max(exercises.length - 1, 0) * REST_BETWEEN_EXERCISES;
                const totalSeconds = totalExerciseSeconds + totalRestBetweenExercises;

                const exerciseList = exercises.map((block, index) => {
                    const perExercise = estimateExerciseSeconds(Number(block.sets));
                    const restAfter = index < exercises.length - 1 ? REST_BETWEEN_EXERCISES : 0;
                    return `
                        <div class="exercise-block">
                            <header>
                                <div>
                                    <strong>${block.name}</strong>
                                    <div class="status">ID: ${block.id}</div>
                                </div>
                                <div class="pill-group">
                                    <span class="badge">${block.sets || 0} sets</span>
                                    <span class="badge">${block.repRange?.min ?? 0}–${block.repRange?.max ?? 0} reps</span>
                                    <span class="badge">${formatSeconds(perExercise)} per exercise</span>
                                    ${restAfter ? `<span class="badge">${formatSeconds(restAfter)} rest before next</span>` : ''}
                                </div>
                            </header>
                            <div class="status">${block.notes || 'No notes'}</div>
                        </div>
                    `;
                }).join('');

                workoutContent.innerHTML = `
                    <div class="exercise-summary">
                        <div class="pill-group">
                            <span class="badge">Total time: ${formatSeconds(totalSeconds)}</span>
                            <span class="badge">Exercises: ${exercises.length}</span>
                        </div>
                        ${exerciseList || '<div class="empty-state">No exercises recorded for this workout.</div>'}
                    </div>
                `;
                detailStatus.textContent = `${workout.name} loaded.`;
            }

            async function loadWorkout(id) {
                detailStatus.textContent = 'Loading workout…';
                workoutContent.innerHTML = '';
                deleteBtn.disabled = true;
                try {
                    const workout = await callApi(`/api/workouts/${encodeURIComponent(id)}`);
                    renderWorkoutDetail(workout);
                } catch (error) {
                    detailStatus.textContent = error.message;
                }
            }

            async function deleteWorkout() {
                if (!selectedWorkoutId) return;
                const confirmed = confirm('Delete this workout template?');
                if (!confirmed) return;
                deleteBtn.disabled = true;
                detailStatus.textContent = 'Deleting workout…';
                try {
                    await callApi(`/api/workouts/${encodeURIComponent(selectedWorkoutId)}`, { method: 'DELETE' });
                    selectedWorkoutId = null;
                    workoutContent.innerHTML = '';
                    detailStatus.textContent = 'Workout deleted. Refreshing list…';
                    await loadWorkouts();
                } catch (error) {
                    detailStatus.textContent = error.message;
                }
            }

            function createExerciseBlock(prefill = {}) {
                const wrapper = document.createElement('div');
                wrapper.className = 'exercise-block';
                wrapper.dataset.blockId = prefill.id || crypto.randomUUID();

                wrapper.innerHTML = `
                    <header>
                        <strong class="exercise-label">Exercise</strong>
                        <div class="exercise-controls">
                            <button type="button" class="secondary" data-action="move-up">Move up</button>
                            <button type="button" class="secondary" data-action="move-down">Move down</button>
                            <button type="button" class="danger" data-action="remove">Delete</button>
                        </div>
                    </header>
                    <div class="exercise-grid">
                        <div class="form-group">
                            <label>Exercise name</label>
                            <input type="text" class="exercise-name" placeholder="e.g. Barbell Bench Press" value="${prefill.name || ''}">
                        </div>
                        <div class="form-group">
                            <label>Sets</label>
                            <input type="number" min="1" class="exercise-sets" value="${prefill.sets || ''}" placeholder="4">
                        </div>
                        <div class="form-group">
                            <label>Rep range min</label>
                            <input type="number" min="1" class="exercise-rep-min" value="${prefill.repRange?.min ?? ''}" placeholder="8">
                        </div>
                        <div class="form-group">
                            <label>Rep range max</label>
                            <input type="number" min="1" class="exercise-rep-max" value="${prefill.repRange?.max ?? ''}" placeholder="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="notes-input" placeholder="RPE, cues, equipment…">${prefill.notes || ''}</textarea>
                    </div>
                `;

                const removeBtn = wrapper.querySelector('[data-action="remove"]');
                const moveUpBtn = wrapper.querySelector('[data-action="move-up"]');
                const moveDownBtn = wrapper.querySelector('[data-action="move-down"]');

                removeBtn.addEventListener('click', () => {
                    wrapper.remove();
                    refreshExerciseLabels();
                });

                moveUpBtn.addEventListener('click', () => {
                    const previous = wrapper.previousElementSibling;
                    if (previous) {
                        exerciseBlocksContainer.insertBefore(wrapper, previous);
                        refreshExerciseLabels();
                    }
                });

                moveDownBtn.addEventListener('click', () => {
                    const next = wrapper.nextElementSibling;
                    if (next) {
                        exerciseBlocksContainer.insertBefore(next, wrapper);
                        refreshExerciseLabels();
                    }
                });

                return wrapper;
            }

            function refreshExerciseLabels() {
                Array.from(exerciseBlocksContainer.children).forEach((block, index) => {
                    const label = block.querySelector('.exercise-label');
                    if (label) {
                        label.textContent = `Exercise ${index + 1}`;
                    }
                });
            }

            function seedInitialExercises() {
                exerciseBlocksContainer.innerHTML = '';
                for (let i = 0; i < DEFAULT_EXERCISE_COUNT; i += 1) {
                    const block = createExerciseBlock();
                    exerciseBlocksContainer.appendChild(block);
                }
                refreshExerciseLabels();
            }

            function gatherExerciseBlocks() {
                return Array.from(exerciseBlocksContainer.children).map((block) => {
                    const name = block.querySelector('.exercise-name').value.trim();
                    const sets = Number(block.querySelector('.exercise-sets').value) || 0;
                    const repMin = Number(block.querySelector('.exercise-rep-min').value) || 0;
                    const repMax = Number(block.querySelector('.exercise-rep-max').value) || 0;
                    const notes = block.querySelector('.notes-input').value.trim();

                    return {
                        id: block.dataset.blockId,
                        name,
                        sets,
                        repRange: { min: repMin, max: repMax },
                        notes,
                    };
                }).filter(block => block.name);
            }

            async function createWorkout() {
                createStatus.textContent = '';
                const name = workoutNameInput.value.trim();
                if (!name) {
                    createStatus.textContent = 'Workout name is required.';
                    return;
                }

                const exerciseBlocks = gatherExerciseBlocks();
                if (!exerciseBlocks.length) {
                    createStatus.textContent = 'Add at least one exercise with a name.';
                    return;
                }

                createStatus.textContent = 'Creating workout…';
                try {
                    const payload = { name, exerciseBlocks };
                    const created = await callApi('/api/workouts', {
                        method: 'POST',
                        body: JSON.stringify(payload),
                    });
                    createStatus.textContent = `Workout “${created.name}” created.`;
                    workoutNameInput.value = '';
                    seedInitialExercises();
                    await loadWorkouts();
                } catch (error) {
                    createStatus.textContent = error.message;
                }
            }

            saveSettingsBtn.addEventListener('click', saveSettings);
            clearSettingsBtn.addEventListener('click', clearSettings);
            refreshBtn.addEventListener('click', loadWorkouts);
            deleteBtn.addEventListener('click', deleteWorkout);
            addExerciseBtn.addEventListener('click', () => {
                const block = createExerciseBlock();
                exerciseBlocksContainer.appendChild(block);
                refreshExerciseLabels();
            });
            createBtn.addEventListener('click', createWorkout);

            loadSettings();
            seedInitialExercises();
        })();
    </script>
</body>

</html>
