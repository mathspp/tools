<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gumroad Link Builder</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            max-width: 960px;
            margin: 0 auto;
            padding: clamp(1.5rem, 3vw, 2.75rem) clamp(1rem, 3vw, 2.75rem) clamp(3rem, 4vw, 4rem);
        }

        header {
            margin-bottom: clamp(1.75rem, 3vw, 2.5rem);
        }

        h1 {
            font-size: clamp(2rem, 3.4vw, 2.75rem);
            margin: 0 0 0.45rem;
            color: var(--tx);
        }

        p.lead {
            margin: 0;
            color: var(--tx-2);
            font-size: clamp(1rem, 2.2vw, 1.2rem);
        }

        .layout {
            display: grid;
            gap: clamp(1.5rem, 3vw, 2.5rem);
        }

        form.surface {
            display: grid;
            gap: clamp(1.25rem, 2.5vw, 1.75rem);
            padding: clamp(1.25rem, 2.6vw, 2rem);
        }

        .form-grid {
            display: grid;
            gap: clamp(1rem, 2vw, 1.25rem);
        }

        .field-group {
            display: grid;
            gap: 0.5rem;
        }

        .field-row {
            display: grid;
            gap: 0.75rem;
        }

        .field-row.split {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            align-items: end;
        }

        label {
            font-weight: 600;
        }

        input[type="text"],
        input[type="url"],
        input[type="email"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
        }

        .helper-text {
            margin: 0;
            color: var(--tx-3);
            font-size: 0.92rem;
        }

        .checkbox-stack {
            display: grid;
            gap: 0.75rem;
        }

        .checkbox-stack label {
            align-items: flex-start;
            gap: 0.6rem;
            font-weight: 500;
        }

        .checkbox-stack label span {
            flex: 1;
            min-width: 0;
        }

        .checkbox-stack input[type="checkbox"] {
            margin-top: 0.25rem;
            flex-shrink: 0;
            width: auto;
        }

        .custom-fields {
            display: grid;
            gap: 0.75rem;
        }

        .custom-field-row {
            display: grid;
            gap: 0.75rem;
        }

        .custom-field-row .pair {
            display: grid;
            gap: 0.5rem;
        }

        @media (min-width: 680px) {
            .custom-field-row {
                grid-template-columns: minmax(180px, 1fr) minmax(200px, 1fr) auto;
                align-items: end;
            }

            .custom-field-row .pair {
                gap: 0.35rem;
            }
        }

        .custom-field-row button {
            align-self: center;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .results.surface {
            padding: clamp(1.25rem, 2.6vw, 2rem);
            display: grid;
            gap: 1rem;
        }

        #generated-link {
            font-family: var(--mono-font, "SFMono-Regular", "Menlo", "Consolas", "Liberation Mono", "Courier New", monospace);
            min-height: 3.2rem;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 0.65rem 0.5rem;
            border-bottom: 1px solid var(--ui-2);
        }

        th {
            font-weight: 600;
            color: var(--tx-2);
        }

        .empty-state {
            margin: 0;
            color: var(--tx-3);
        }

        .sr-only {
            border: 0;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }

        @media (min-width: 920px) {
            .layout {
                grid-template-columns: 1fr minmax(260px, 320px);
            }

            .results.surface {
                height: fit-content;
                position: sticky;
                top: clamp(1.5rem, 4vw, 3rem);
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Gumroad Link Builder</h1>
        <p class="lead">Compose Gumroad product URLs with optional checkout parameters to prefill your customer’s
            experience.</p>
    </header>

    <div class="layout">
        <form id="gumroad-form" class="surface" autocomplete="off">
            <div class="form-grid">
                <div class="field-row split">
                    <div class="field-group">
                        <label for="username">Gumroad username</label>
                        <input type="text" id="username" name="username" placeholder="username" value="mathspp">
                        <div class="actions">
                            <button type="button" id="fetch-products">Fetch products</button>
                        </div>
                        <p class="helper-text" id="fetch-status" role="status" aria-live="polite" hidden></p>
                    </div>
                    <div class="field-group">
                        <label for="product-slug">Product ID</label>
                        <input type="text" id="product-slug" name="product-slug" placeholder="product" value="">
                    </div>
                </div>

                <div class="field-group" id="product-select-group" hidden>
                    <label for="product-select">Products found</label>
                    <select id="product-select" name="product-select">
                        <option value="">Select a product</option>
                    </select>
                    <p class="helper-text">Selecting a product updates the Product ID field automatically.</p>
                </div>

                <div class="field-group">
                    <label for="product-url">Product URL</label>
                    <input type="url" id="product-url" name="product-url"
                        placeholder="https://username.gumroad.com/l/product" value="https://mathspp.gumroad.com"
                        readonly required>
                    <p class="helper-text">Fill out the username and product fields below to compose it automatically.
                    </p>
                </div>

                <div class="field-group">
                    <label for="discount-code">Discount code (optional)</label>
                    <input type="text" id="discount-code" name="discount-code" placeholder="SUMMER25">
                </div>

                <fieldset class="checkbox-stack">
                    <legend>Checkout behaviour</legend>
                    <label for="wanted">
                        <input type="checkbox" id="wanted" name="wanted">
                        <span>Take the customer straight to checkout</span>
                    </label>
                    <label for="pay_in_installments">
                        <input type="checkbox" id="pay_in_installments" name="pay_in_installments">
                        <span>Prefer the installments option when available</span>
                    </label>
                </fieldset>

                <div class="field-group">
                    <label for="frequency">Membership payment frequency</label>
                    <select id="frequency" name="frequency">
                        <option value="">No preference</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="biannually">Biannually</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div class="field-group">
                    <label for="variant">Variant / version / tier</label>
                    <input type="text" id="variant" name="variant" placeholder="Professional">
                    <p class="helper-text">Links to a specific variant. The value will be URL encoded for
                        you.</p>
                </div>

                <div class="field-row split">
                    <div class="field-group">
                        <label for="price">Pay-what-you-want price</label>
                        <input type="number" id="price" name="price" min="0" step="0.01" placeholder="20">
                    </div>
                    <div class="field-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" step="1" placeholder="1">
                    </div>
                </div>

                <div class="field-row split">
                    <div class="field-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="customer@example.com">
                    </div>
                    <div class="field-group">
                        <label for="referrer">Referrer</label>
                        <input type="url" id="referrer" name="referrer" placeholder="https://twitter.com">
                    </div>
                </div>

                <section class="field-group">
                    <div class="field-row">
                        <div>
                            <h2 style="margin: 0; font-size: 1.1rem;">Custom checkout fields</h2>
                            <p class="helper-text">Provide the exact label from your Gumroad custom field to prefill it.
                                Only rows with both a label and value are added.</p>
                        </div>
                        <div class="actions">
                            <button type="button" id="add-custom-field">Add custom field</button>
                        </div>
                    </div>
                    <div id="custom-fields" class="custom-fields" aria-live="polite"></div>
                </section>
            </div>

            <div class="actions">
                <button type="reset">Reset</button>
            </div>
        </form>

        <section class="surface results" aria-live="polite">
            <div>
                <h2>Generated link</h2>
                <textarea id="generated-link" readonly placeholder="Your URL will appear here"></textarea>
            </div>
            <div class="actions">
                <button type="button" id="copy-button" disabled>Copy link</button>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 1.1rem;">Included parameters</h3>
                <div class="table-container">
                    <table aria-describedby="parameters-description">
                        <thead>
                            <tr>
                                <th scope="col">Parameter</th>
                                <th scope="col">Value</th>
                            </tr>
                        </thead>
                        <tbody id="parameters-body">
                            <tr>
                                <td colspan="2">
                                    <p class="empty-state" id="parameters-description">No query parameters yet. Fill in
                                        the
                                        form to generate them.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <template id="custom-field-template">
        <div class="custom-field-row">
            <div class="pair">
                <label class="sr-only" data-role="name-label">Custom field label</label>
                <input type="text" data-role="custom-name" placeholder="Custom field label">
            </div>
            <div class="pair">
                <label class="sr-only" data-role="value-label">Custom field value</label>
                <input type="text" data-role="custom-value" placeholder="Prefilled value">
            </div>
            <button type="button" class="remove-field">Remove</button>
        </div>
    </template>

    <script>
        (function () {
            const form = document.getElementById('gumroad-form');
            const output = document.getElementById('generated-link');
            const copyButton = document.getElementById('copy-button');
            const paramsTableBody = document.getElementById('parameters-body');
            const customFieldsContainer = document.getElementById('custom-fields');
            const addCustomFieldButton = document.getElementById('add-custom-field');
            const template = document.getElementById('custom-field-template');
            const productUrlInput = document.getElementById('product-url');
            const usernameInput = document.getElementById('username');
            const productSlugInput = document.getElementById('product-slug');
            const fetchProductsButton = document.getElementById('fetch-products');
            const productSelect = document.getElementById('product-select');
            const productSelectGroup = document.getElementById('product-select-group');
            const fetchStatus = document.getElementById('fetch-status');
            const fetchButtonDefaultText = fetchProductsButton ? fetchProductsButton.textContent : '';

            let customFieldCount = 0;
            let syncingFromParts = false;
            let syncingFromUrl = false;

            function normaliseBaseUrl(url) {
                return url.replace(/\s+/g, '').replace(/\/+$/, '');
            }

            function sanitiseSlug(value) {
                let slug = value.trim();
                if (/https?:\/\//i.test(slug)) {
                    const parsed = parseProductUrl(slug);
                    if (parsed) {
                        slug = parsed.slug;
                    }
                }
                slug = slug.replace(/^\/+/, '');
                if (slug.startsWith('l/')) {
                    slug = slug.slice(2);
                }
                const slashIndex = slug.indexOf('/');
                if (slashIndex !== -1) {
                    slug = slug.slice(0, slashIndex);
                }
                const queryIndex = slug.indexOf('?');
                if (queryIndex !== -1) {
                    slug = slug.slice(0, queryIndex);
                }
                const hashIndex = slug.indexOf('#');
                if (hashIndex !== -1) {
                    slug = slug.slice(0, hashIndex);
                }
                return slug;
            }

            function composeProductUrl(username, slug) {
                const cleanUsername = username.trim();
                const cleanSlug = sanitiseSlug(slug);
                if (!cleanUsername || !cleanSlug) {
                    return '';
                }
                return `https://${cleanUsername}.gumroad.com/l/${cleanSlug}`;
            }

            function parseProductUrl(value) {
                if (!value) {
                    return null;
                }
                let parsedValue = value.trim();
                if (!/^https?:\/\//i.test(parsedValue)) {
                    parsedValue = `https://${parsedValue}`;
                }
                try {
                    const url = new URL(parsedValue);
                    const hostParts = url.hostname.split('.');
                    if (hostParts.length < 2 || hostParts.slice(-2).join('.') !== 'gumroad.com') {
                        return null;
                    }
                    const username = hostParts.length > 2 ? hostParts[0] : '';
                    const path = url.pathname.replace(/^\/+/, '');
                    const segments = path.split('/');
                    if (segments[0] !== 'l' || !segments[1]) {
                        return null;
                    }
                    const canonicalBase = normaliseBaseUrl(`${url.origin}${url.pathname}`);
                    return {
                        username,
                        slug: segments[1],
                        canonicalBase,
                    };
                } catch (error) {
                    return null;
                }
            }

            function updateUrlFromParts() {
                if (syncingFromUrl) {
                    return;
                }
                const username = usernameInput.value.trim();
                const slug = sanitiseSlug(productSlugInput.value);
                if (productSlugInput.value !== slug) {
                    productSlugInput.value = slug;
                }
                const composedUrl = composeProductUrl(username, slug);
                syncingFromParts = true;
                productUrlInput.value = composedUrl;
                syncingFromParts = false;
                buildLink();
            }

            function updatePartsFromUrl() {
                if (syncingFromParts) {
                    return;
                }
                const rawUrl = productUrlInput.value.trim();
                const parts = parseProductUrl(rawUrl);
                syncingFromUrl = true;
                if (parts) {
                    usernameInput.value = parts.username;
                    productSlugInput.value = parts.slug;
                    if (parts.canonicalBase && productUrlInput.value.trim() !== parts.canonicalBase) {
                        productUrlInput.value = parts.canonicalBase;
                    }
                } else if (!rawUrl) {
                    usernameInput.value = '';
                    productSlugInput.value = '';
                }
                syncingFromUrl = false;
                buildLink();
            }

            function buildLink() {
                const formData = new FormData(form);
                const rawUrl = (formData.get('product-url') || '').trim();

                if (!rawUrl) {
                    output.value = '';
                    copyButton.disabled = true;
                    paramsTableBody.innerHTML = `
                        <tr>
                            <td colspan="2">
                                <p class="empty-state">No query parameters yet. Fill in the form to generate them.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                let baseUrl = normaliseBaseUrl(rawUrl);
                const discountCode = (formData.get('discount-code') || '').trim();
                if (discountCode) {
                    baseUrl = `${baseUrl}/${encodeURIComponent(discountCode)}`;
                }

                const params = new URLSearchParams();

                if (formData.get('wanted')) {
                    params.set('wanted', 'true');
                }

                if (formData.get('pay_in_installments')) {
                    params.set('pay_in_installments', 'true');
                }

                const frequency = formData.get('frequency');
                if (frequency) {
                    params.set(frequency, 'true');
                }

                const variant = (formData.get('variant') || '').trim();
                if (variant) {
                    params.set('variant', variant);
                }

                const email = (formData.get('email') || '').trim();
                if (email) {
                    params.set('email', email);
                }

                const price = (formData.get('price') || '').trim();
                if (price) {
                    params.set('price', price);
                }

                const quantity = (formData.get('quantity') || '').trim();
                if (quantity) {
                    params.set('quantity', quantity);
                }

                const referrer = (formData.get('referrer') || '').trim();
                if (referrer) {
                    params.set('referrer', referrer);
                }

                const customFieldRows = customFieldsContainer.querySelectorAll('.custom-field-row');
                customFieldRows.forEach((row) => {
                    const nameInput = row.querySelector('[data-role="custom-name"]');
                    const valueInput = row.querySelector('[data-role="custom-value"]');
                    const name = nameInput.value.trim();
                    const value = valueInput.value.trim();
                    if (name && value) {
                        params.set(name, value);
                    }
                });

                const queryString = params.toString();
                let finalUrl = baseUrl;
                if (queryString) {
                    if (/[?&]$/.test(baseUrl)) {
                        finalUrl = `${baseUrl}${queryString}`;
                    } else {
                        const separator = baseUrl.includes('?') ? '&' : '?';
                        finalUrl = `${baseUrl}${separator}${queryString}`;
                    }
                }

                output.value = finalUrl;
                copyButton.disabled = !finalUrl;
                if (copyButton.disabled) {
                    copyButton.textContent = 'Copy link';
                }

                if (queryString) {
                    const rows = Array.from(params.entries()).map(([key, value]) => `
                        <tr>
                            <td><code>${key}</code></td>
                            <td><code>${value}</code></td>
                        </tr>
                    `);
                    paramsTableBody.innerHTML = rows.join('');
                } else {
                    paramsTableBody.innerHTML = `
                        <tr>
                            <td colspan="2">
                                <p class="empty-state">No query parameters included.</p>
                            </td>
                        </tr>
                    `;
                }
            }

            function addCustomField() {
                const clone = template.content.firstElementChild.cloneNode(true);
                customFieldCount += 1;
                const nameInput = clone.querySelector('[data-role="custom-name"]');
                const valueInput = clone.querySelector('[data-role="custom-value"]');
                const nameLabel = clone.querySelector('[data-role="name-label"]');
                const valueLabel = clone.querySelector('[data-role="value-label"]');
                const nameId = `custom-name-${customFieldCount}`;
                const valueId = `custom-value-${customFieldCount}`;

                nameInput.id = nameId;
                valueInput.id = valueId;
                nameLabel.setAttribute('for', nameId);
                valueLabel.setAttribute('for', valueId);

                customFieldsContainer.appendChild(clone);
                buildLink();
                nameInput.focus();
            }

            function handleCustomFieldInteraction(event) {
                if (event.target.classList.contains('remove-field')) {
                    event.preventDefault();
                    const row = event.target.closest('.custom-field-row');
                    if (row) {
                        row.remove();
                        buildLink();
                    }
                }
            }

            function setFetchStatus(message) {
                if (!fetchStatus) {
                    return;
                }
                if (message) {
                    fetchStatus.textContent = message;
                    fetchStatus.hidden = false;
                } else {
                    fetchStatus.textContent = '';
                    fetchStatus.hidden = true;
                }
            }

            function parseProductsFromProfile(html, profileUrl, username) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const productCards = Array.from(doc.querySelectorAll('article.product-card'));
                const products = new Map();

                for (const card of productCards) {
                    const link = card.querySelector('a[href]');
                    if (!link) {
                        continue;
                    }
                    let resolvedUrl;
                    try {
                        resolvedUrl = new URL(link.getAttribute('href'), profileUrl);
                    } catch (error) {
                        continue;
                    }
                    const slug = sanitiseSlug(resolvedUrl.pathname);
                    if (!slug || products.has(slug)) {
                        continue;
                    }
                    const titleElement = card.querySelector('[itemprop="name"], h4, h3') || link;
                    const name = (titleElement.textContent || '').trim();
                    const productUrl = composeProductUrl(username, slug) || resolvedUrl.href;
                    products.set(slug, {
                        slug,
                        name: name || slug,
                        url: productUrl,
                    });
                }

                return Array.from(products.values());
            }

            function populateProductSelect(products) {
                if (!productSelectGroup || !productSelect) {
                    return;
                }

                productSelect.innerHTML = '<option value="">Select a product</option>';

                for (const product of products) {
                    const option = document.createElement('option');
                    option.value = product.slug;
                    option.textContent = product.name;
                    option.dataset.url = product.url;
                    productSelect.appendChild(option);
                }

                productSelectGroup.hidden = products.length === 0;
            }

            function resetProductSelect() {
                if (!productSelectGroup || !productSelect) {
                    return;
                }
                productSelect.innerHTML = '<option value="">Select a product</option>';
                productSelectGroup.hidden = true;
            }

            form.addEventListener('input', buildLink);
            form.addEventListener('change', buildLink);
            form.addEventListener('reset', () => {
                window.setTimeout(() => {
                    customFieldsContainer.innerHTML = '';
                    usernameInput.value = '';
                    productSlugInput.value = '';
                    resetProductSelect();
                    setFetchStatus('');
                    buildLink();
                }, 0);
            });

            addCustomFieldButton.addEventListener('click', (event) => {
                event.preventDefault();
                addCustomField();
            });

            customFieldsContainer.addEventListener('click', handleCustomFieldInteraction);

            customFieldsContainer.addEventListener('input', () => {
                buildLink();
            });

            usernameInput.addEventListener('input', updateUrlFromParts);
            productSlugInput.addEventListener('input', updateUrlFromParts);
            productUrlInput.addEventListener('input', updatePartsFromUrl);
            productUrlInput.addEventListener('change', updatePartsFromUrl);

            let isFetching = false;

            if (fetchProductsButton) {
                fetchProductsButton.addEventListener('click', async () => {
                    if (isFetching) return; // guard

                    const rawUsername = usernameInput.value.trim();
                    const cleanUsername = rawUsername.replace(/\s+/g, '');

                    if (!cleanUsername) {
                        setFetchStatus('Enter a Gumroad username first.');
                        resetProductSelect();
                        return;
                    }
                    if (cleanUsername !== rawUsername) {
                        usernameInput.value = cleanUsername;
                    }

                    const apiUrl = `https://gumroad-products-production.rodrigogiraoserrao.workers.dev/api/gumroad-products?u=${encodeURIComponent(cleanUsername)}`;

                    // disable immediately
                    isFetching = true;
                    fetchProductsButton.disabled = true;
                    const oldText = fetchButtonDefaultText || fetchProductsButton.textContent || 'Fetch products';
                    fetchProductsButton.textContent = 'Fetching…';
                    setFetchStatus(`Fetching ${cleanUsername}…`);

                    try {
                        const response = await fetch(apiUrl, { credentials: 'omit' });
                        // Peek diagnostics
                        const xCache = response.headers.get('X-Cache');
                        const xUp = response.headers.get('X-Upstream-Status');

                        if (!response.ok) {
                            // show more helpful status to you in the UI
                            throw new Error(`Request failed: ${response.status} (X-Cache=${xCache}, Upstream=${xUp})`);
                        }

                        const data = await response.json();
                        const products = (data.products || []).map(p => ({
                            title: p.title,
                            slug: p.slug,
                            url: p.url,
                        }));

                        if (products.length === 0) {
                            populateProductSelect([]);
                            setFetchStatus('No products were found on that profile.');
                            return;
                        }

                        populateProductSelect(products);
                        setFetchStatus(`Found ${products.length} product${products.length === 1 ? '' : 's'}. Select one below.`);

                    } catch (err) {
                        console.error('Unable to fetch products', err);
                        resetProductSelect();
                        setFetchStatus('Unable to fetch products.');
                    } finally {
                        isFetching = false;
                        fetchProductsButton.disabled = false;
                        fetchProductsButton.textContent = fetchButtonDefaultText || 'Fetch products';
                    }
                });
            }

            if (productSelect) {
                productSelect.addEventListener('change', () => {
                    const selectedOption = productSelect.selectedOptions[0];
                    if (!selectedOption || !selectedOption.value) {
                        return;
                    }

                    const selectedSlug = selectedOption.value;
                    const selectedUrl = selectedOption.dataset.url || '';

                    productSlugInput.value = selectedSlug;

                    if (selectedUrl) {
                        productUrlInput.value = selectedUrl;
                    }

                    updatePartsFromUrl();
                });
            }

            copyButton.addEventListener('click', async () => {
                const text = output.value.trim();
                if (!text) {
                    return;
                }

                try {
                    await navigator.clipboard.writeText(text);
                    copyButton.textContent = 'Copied!';
                    window.setTimeout(() => {
                        copyButton.textContent = 'Copy link';
                    }, 1500);
                } catch (error) {
                    output.focus();
                    output.select();
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            copyButton.textContent = 'Copied!';
                            window.setTimeout(() => {
                                copyButton.textContent = 'Copy link';
                            }, 1500);
                        }
                    } catch (fallbackError) {
                        console.error('Copy failed', fallbackError);
                    }
                }
            });

            // Initialise state on load
            updatePartsFromUrl();
            buildLink();
        })();
    </script>
</body>

</html>
