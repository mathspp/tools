<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Exercise Records</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { max-width: 900px; margin: 0 auto; padding: 24px 20px 64px; }
        main { display: grid; gap: 1rem; }
        .card { padding: 1rem; }
        .status { min-height: 1.2rem; color: var(--text-muted); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.5rem; border-bottom: 1px solid var(--border); text-align: left; }
        form { display: grid; gap: 0.75rem; }
        .grid { display: grid; gap: 0.5rem; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .status-text { color: var(--text-muted); }

        .add-record-card { display: grid; gap: 0.75rem; }

        .add-record-header { display: flex; align-items: center; }

        .add-record-form {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            align-items: end;
        }

        .add-record-form button {
            width: 100%;
            justify-self: end;
        }

        @media (max-width: 540px) {
            .add-record-form {
                grid-template-columns: 1fr;
            }

            .add-record-form button {
                justify-self: stretch;
            }
        }

        .workout-links {
            border: 1px solid var(--border);
            background: var(--surface-1);
        }

        .link-grid {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .link-card {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            padding: 0.65rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface-2);
            text-decoration: none;
            font-weight: 600;
        }

        .link-card:hover { border-color: var(--accent); }

        #exercise-select { align-self: start; }

        .record-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
            width: 100%;
        }

        .record-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .record-actions button {
            white-space: nowrap;
        }

        .record-table-container {
            display: grid;
            gap: 0.25rem;
        }

        .record-table {
            width: 100%;
        }

        .record-table caption {
            caption-side: top;
            text-align: left;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <header class="page-header">
        <a class="site-link" href="https://tools.mathspp.com/" aria-label="Back to tools.mathspp.com">‚Üê tools.mathspp.com</a>
        <h1>Workout Exercise Records</h1>
        <p class="lead">View and update personal bests for any exercise.</p>
        <p class="status-text">Configure the API base URL and bearer token in <a href="workout-settings.html">Workout settings</a>. Stored values are reused automatically.</p>
    </header>

    <main>

        <section class="card">
            <h2>Records</h2>
            <div class="record-controls">
                <select id="exercise-select"></select>
                <div class="record-actions">
                    <button id="get-records">Get records</button>
                    <button id="refresh-exercises">Refresh list</button>
                </div>
            </div>
            <div class="record-table-container">
                <div id="load-status" class="status"></div>
                <table class="record-table">
                    <caption id="records-caption" aria-live="polite">Select an exercise to view records</caption>
                    <thead><tr><th>Weight</th><th>Reps</th></tr></thead>
                    <tbody id="record-rows"></tbody>
                </table>
            </div>
        </section>

        <section class="card add-record-card">
            <div class="add-record-header">
                <h2>Add record</h2>
            </div>
            <form id="record-form" class="add-record-form">
                <label>Weight<input type="number" step="0.1" id="record-weight" required></label>
                <label>Reps<input type="number" id="record-reps" required></label>
                <button type="submit">Add record</button>
            </form>
            <div id="record-status" class="status"></div>
        </section>
        <section class="surface stack workout-links" aria-label="Workout tools navigation">
            <h2 style="margin: 0;">Workout tools</h2>
            <p class="status-text">Quick links to the rest of the workout suite.</p>
            <div class="link-grid">
                <a class="link-card" href="workout-settings.html">Workout settings<span>‚Üí</span></a>
                <a class="link-card" href="workout-template-manager.html">Workout template manager<span>‚Üí</span></a>
                <a class="link-card" href="workout-session-logger.html">Workout session logger<span>‚Üí</span></a>
                <a class="link-card" href="workout-session-viewer.html">Workout session viewer<span>‚Üí</span></a>
                <a class="link-card" href="workout-exercise-manager.html">Workout exercise manager<span>‚Üí</span></a>
                <a class="link-card" href="workout-exercise-record.html">Workout exercise records<span>‚Üí</span></a>
            </div>
        </section>
    </main>

    <script>
        const exerciseSelect = document.getElementById('exercise-select');
        const loadStatus = document.getElementById('load-status');
        const recordRows = document.getElementById('record-rows');
        const recordStatus = document.getElementById('record-status');
        const recordWeight = document.getElementById('record-weight');
        const recordReps = document.getElementById('record-reps');
        const recordsCaption = document.getElementById('records-caption');

        const STORAGE_KEYS = { base: 'workout-api-base', token: 'workout-api-token' };

        function getConfig() {
            const base = (localStorage.getItem(STORAGE_KEYS.base) || '').trim();
            const token = (localStorage.getItem(STORAGE_KEYS.token) || '').trim();
            if (!base || !token) {
                throw new Error('Set the API base URL and bearer token in Workout settings first.');
            }
            return { base, token };
        }

        async function apiFetch(path, options = {}) {
            const { base, token } = getConfig();
            const response = await fetch(`${base.replace(/\/$/, '')}${path}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                    ...(options.headers || {}),
                },
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data?.error?.message || response.statusText);
            return data;
        }

        async function loadExercises() {
            loadStatus.textContent = 'Loading exercises...';
            exerciseSelect.innerHTML = '';
            try {
                const data = await apiFetch('/exercises');
                if (!data.exercises.length) {
                    loadStatus.textContent = 'No exercises found.';
                    return;
                }
                data.exercises.forEach((ex) => {
                    const option = document.createElement('option');
                    option.value = ex.name;
                    option.textContent = ex.display_name;
                    option.dataset.displayName = ex.display_name;
                    exerciseSelect.appendChild(option);
                });
                loadStatus.textContent = '';
                updateRecordsCaption('');
                recordRows.innerHTML = '';
            } catch (error) {
                loadStatus.textContent = error.message;
            }
        }

        function updateRecordsCaption(name, hasRecords) {
            if (!name) {
                recordsCaption.textContent = 'Select an exercise to view records';
                return;
            }

            recordsCaption.textContent = hasRecords === false
                ? `No ${name} records`
                : `${name} records`;
        }

        async function loadRecords() {
            const selected = exerciseSelect.selectedOptions[0];
            if (!selected) return;
            const displayName = selected.dataset.displayName || selected.textContent;
            const name = selected.value;
            updateRecordsCaption(displayName);
            loadStatus.textContent = `Loading records for ${displayName}...`;
            recordRows.innerHTML = '';
            try {
                const data = await apiFetch(`/exercises/${encodeURIComponent(name)}/records`);
                (data.records || []).forEach((rec) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${rec.weight}</td><td>${rec.reps}</td>`;
                    recordRows.appendChild(row);
                });
                if (!data.records || data.records.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="2">No personal bests yet.</td>';
                    recordRows.appendChild(row);
                }
                updateRecordsCaption(displayName, data.records && data.records.length > 0);
                loadStatus.textContent = '';
            } catch (error) {
                loadStatus.textContent = error.message;
            }
        }

        function dominates(a, b) {
            return (
                a.weight >= b.weight &&
                a.reps >= b.reps &&
                (a.weight > b.weight || a.reps > b.reps)
            );
        }

        function clearRecordInputs() {
            recordWeight.value = '';
            recordReps.value = '';
        }

        document.getElementById('refresh-exercises').addEventListener('click', loadExercises);
        document.getElementById('get-records').addEventListener('click', () => {
            clearRecordInputs();
            recordStatus.textContent = '';
            loadRecords();
        });
        exerciseSelect.addEventListener('change', () => {
            clearRecordInputs();
            recordStatus.textContent = '';
            loadStatus.textContent = '';
            updateRecordsCaption('');
            recordRows.innerHTML = '';
        });

        document.getElementById('record-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = exerciseSelect.value;
            if (!name) return;

            recordStatus.textContent = 'Checking record...';
            try {
                const current = await apiFetch(`/exercises/${encodeURIComponent(name)}/records`);
                const records = current.records || [];
                const newRecord = {
                    weight: Number(recordWeight.value),
                    reps: Number(recordReps.value),
                };

                const isDuplicate = records.some(
                    (r) => r.weight === newRecord.weight && r.reps === newRecord.reps
                );
                const dominatedByExisting = records.some((r) => dominates(r, newRecord));

                if (isDuplicate || dominatedByExisting) {
                    recordStatus.textContent = 'Record not submitted: an existing record is better.';
                    return;
                }

                const updatedRecords = records.filter((r) => !dominates(newRecord, r));
                updatedRecords.push(newRecord);

                recordStatus.textContent = 'Saving records...';
                await apiFetch(`/exercises/${encodeURIComponent(name)}/records`, {
                    method: 'PUT',
                    body: JSON.stringify({ records: updatedRecords }),
                });
                recordStatus.textContent = 'Records updated.';
                loadRecords();
            } catch (error) {
                recordStatus.textContent = error.message;
            }
        });

        loadExercises();
    </script>

    <footer class="page-footer">
        <p>Built with ‚ù§Ô∏è, ü§ñ, and üêç, by <a href="https://mathspp.com/">Rodrigo Gir√£o Serr√£o</a></p>
    </footer>
</body>
</html>
