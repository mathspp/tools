<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Session Logger</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --card-padding: clamp(1rem, 3vw, 1.5rem);
        }

        body {
            max-width: 1024px;
            margin: 0 auto;
            padding: 20px 16px 64px;
        }

        main {
            display: grid;
            gap: 1rem;
        }

        .surface {
            padding: var(--card-padding);
        }

        .stack {
            display: grid;
            gap: 0.75rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .status-text {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        select,
        input,
        textarea {
            width: 100%;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        .exercise-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface-2);
            overflow: hidden;
        }

        .exercise-card summary {
            padding: 0.85rem 1rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .exercise-card[open] summary {
            border-bottom: 1px solid var(--border);
            background: var(--surface-3);
        }

        .exercise-body {
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
        }

        .set-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            align-items: center;
        }

        .chip-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-3);
            font-size: 0.9rem;
        }

        .exercise-meta,
        .inline-note {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .template-grid {
            display: grid;
            gap: 0.75rem;
        }

        .sticky-footer {
            position: sticky;
            bottom: 0;
            background: var(--surface-1);
            padding: 0.75rem 0;
            border-top: 1px solid var(--border);
        }

        .workout-links {
            border: 1px solid var(--border);
            background: var(--surface-1);
        }

        .link-grid {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .link-card {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            padding: 0.65rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface-2);
            text-decoration: none;
            font-weight: 600;
        }

        .link-card:hover { border-color: var(--accent); }

        @media (max-width: 640px) {
            .exercise-card summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }

            header h1 {
                font-size: 1.7rem;
            }
        }
    </style>
</head>

<body>
    <header class="page-header">
        <a class="site-link" href="https://tools.mathspp.com/" aria-label="Back to tools.mathspp.com">‚Üê tools.mathspp.com</a>
        <h1>Workout Session Logger</h1>
        <p class="lead">Fill a workout template from the Cloudflare Worker, with autosave and last-session guidance.</p>
    </header>

    <main>
        <section class="surface stack">
            <h2 style="margin: 0;">API configuration</h2>
            <p class="status-text">Set the API base URL and bearer token once in <a href="workout-settings.html">Workout settings</a>. Stored values are reused automatically.</p>
        </section>

        <section class="surface stack">
            <div class="controls" style="justify-content: space-between; align-items: center; gap: 1rem;">
                <div class="stack" style="gap: 0.35rem;">
                    <h2 style="margin: 0;">Select workout</h2>
                    <p class="status-text" id="workout-hint">Load a template to begin logging.</p>
                </div>
                <button type="button" id="refresh-templates" class="secondary">Refresh templates</button>
            </div>
            <div class="stack">
                <label for="template-select">Workout template</label>
                <select id="template-select">
                    <option value="">Choose a template‚Ä¶</option>
                </select>
            </div>
            <div class="status-text" id="template-status" aria-live="polite"></div>
        </section>

        <section class="surface stack" id="workout-panel" hidden>
            <div class="template-grid">
                <div>
                    <div class="controls" style="justify-content: space-between; align-items: center;">
                        <div>
                            <h2 id="workout-title" style="margin: 0;"></h2>
                            <p class="status-text" id="workout-summary" style="margin: 4px 0 0;"></p>
                        </div>
                        <span class="chip" id="storage-indicator">Draft saved locally</span>
                    </div>
                    <p class="status-text" id="last-session-status"></p>
                </div>

                <div class="stack" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); display: grid; gap: 0.75rem;">
                    <label for="session-date">Session date</label>
                    <input id="session-date" type="date">
                    <label for="overall-notes">Overall notes</label>
                    <textarea id="overall-notes" placeholder="Fatigue, sleep, aches‚Ä¶"></textarea>
                </div>

                <div id="exercise-list" class="stack"></div>
            </div>

            <div class="sticky-footer">
                <div class="controls" style="justify-content: space-between;">
                    <div class="status-text" id="save-status" aria-live="polite"></div>
                    <button type="button" id="submit-workout">Submit workout</button>
                </div>
            </div>
        </section>

        <section class="surface stack workout-links" aria-label="Workout tools navigation">
            <h2 style="margin: 0;">Workout tools</h2>
            <p class="status-text">Quick links to the rest of the workout suite.</p>
            <div class="link-grid">
                <a class="link-card" href="workout-settings.html">Workout settings<span>‚Üí</span></a>
                <a class="link-card" href="workout-template-manager.html">Workout template manager<span>‚Üí</span></a>
                <a class="link-card" href="workout-session-logger.html">Workout session logger<span>‚Üí</span></a>
                <a class="link-card" href="workout-session-viewer.html">Workout session viewer<span>‚Üí</span></a>
                <a class="link-card" href="workout-exercise-manager.html">Workout exercise manager<span>‚Üí</span></a>
                <a class="link-card" href="workout-exercise-record.html">Workout exercise records<span>‚Üí</span></a>
            </div>
        </section>
    </main>

    <script>
        (() => {
            const STORAGE_KEYS = {
                token: 'workout-api-token',
                base: 'workout-api-base',
                draftPrefix: 'workout_session_draft_',
            };

            const elements = {
                refreshTemplates: document.getElementById('refresh-templates'),
                templateSelect: document.getElementById('template-select'),
                templateStatus: document.getElementById('template-status'),
                workoutPanel: document.getElementById('workout-panel'),
                workoutTitle: document.getElementById('workout-title'),
                workoutSummary: document.getElementById('workout-summary'),
                exerciseList: document.getElementById('exercise-list'),
                workoutHint: document.getElementById('workout-hint'),
                lastSessionStatus: document.getElementById('last-session-status'),
                overallNotes: document.getElementById('overall-notes'),
                sessionDate: document.getElementById('session-date'),
                submitWorkout: document.getElementById('submit-workout'),
                saveStatus: document.getElementById('save-status'),
                storageIndicator: document.getElementById('storage-indicator'),
            };

            const state = {
                templates: [],
                selectedTemplate: null,
                latestSession: null,
                autosaveTimer: null,
            };

            function draftKey(name) {
                return `${STORAGE_KEYS.draftPrefix}${name}`;
            }

            function readStored(primaryKey, legacyKey) {
                return (localStorage.getItem(primaryKey) || localStorage.getItem(legacyKey) || '').trim();
            }

            function getConfig() {
                const token = readStored(STORAGE_KEYS.token, 'workout_api_token');
                const base = readStored(STORAGE_KEYS.base, 'workout_api_base').replace(/\/$/, '');
                if (!token || !base) {
                    throw new Error('Set the API base URL and bearer token in Workout settings first.');
                }
                return { token, base };
            }

            async function callApi(path, options = {}) {
                const { token, base } = getConfig();

                const headers = new Headers(options.headers || {});
                headers.set('Content-Type', 'application/json');
                headers.set('Authorization', `Bearer ${token}`);

                const response = await fetch(`${base}${path}`, { ...options, headers });
                let data = null;
                try {
                    data = await response.json();
                } catch (error) {
                    // ignore
                }

                if (response.status === 401) {
                    throw new Error('Unauthorized ‚Äì check the token.');
                }

                if (!response.ok) {
                    throw new Error((data && data.error && data.error.message) || 'Request failed');
                }

                return data;
            }

            function templateDescription(template) {
                const setCount = template.exercise_blocks.reduce((acc, block) => acc + block.sets, 0);
                return `${template.exercise_blocks.length} exercises ¬∑ ${setCount} total sets`;
            }

            function populateTemplateSelect(templates) {
                elements.templateSelect.innerHTML = '<option value="">Choose a template‚Ä¶</option>';
                templates.forEach((name) => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    elements.templateSelect.appendChild(option);
                });
            }

            async function refreshTemplates() {
                elements.templateStatus.textContent = 'Loading templates‚Ä¶';
                try {
                    const data = await callApi('/templates');
                    state.templates = data.templates || [];
                    populateTemplateSelect(state.templates);
                    elements.templateStatus.textContent = `${state.templates.length} template${state.templates.length === 1 ? '' : 's'} loaded.`;
                    elements.workoutHint.textContent = 'Choose a template to start logging.';
                } catch (error) {
                    elements.templateStatus.textContent = error.message;
                }
            }

            function getDraft(templateName) {
                const raw = localStorage.getItem(draftKey(templateName));
                if (!raw) return null;
                try {
                    return JSON.parse(raw);
                } catch (error) {
                    return null;
                }
            }

            function persistDraft(templateName, payload) {
                localStorage.setItem(draftKey(templateName), JSON.stringify(payload));
                elements.storageIndicator.textContent = 'Draft saved locally';
            }

            function clearDraft(templateName) {
                localStorage.removeItem(draftKey(templateName));
            }

            function repOptions(block) {
                if (block.amrap) return [];
                const options = [];
                const min = Number(block.min_reps) || 1;
                const max = Number(block.max_reps) || min;
                for (let i = min; i <= max; i += 1) {
                    options.push(i);
                }
                return options;
            }

            function findPreviousExercise(exerciseName) {
                if (!state.latestSession) return null;
                return state.latestSession.exercise_blocks.find((ex) => ex.exercise_name === exerciseName) || null;
            }

            function renderPreviousChip(block) {
                const prev = findPreviousExercise(block.exercise_name);
                if (!prev) return null;
                const firstCompleted = prev.sets.find((set) => Number.isFinite(set.weight) || Number.isFinite(set.reps));
                if (!firstCompleted) return null;
                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.textContent = `Last: ${firstCompleted.weight ?? '‚Äî'} kg ¬∑ ${firstCompleted.reps ?? '‚Äî'} reps`;
                return chip;
            }

            function createAmrapInput(exerciseName, setIndex, initialValue) {
                const input = document.createElement('input');
                input.type = 'number';
                input.inputMode = 'numeric';
                input.min = '1';
                input.step = '1';
                input.placeholder = 'Reps (AMRAP)';
                input.dataset.exerciseName = exerciseName;
                input.dataset.setIndex = setIndex;
                input.dataset.field = 'reps';

                if (Number.isInteger(initialValue)) {
                    input.value = initialValue;
                }

                input.addEventListener('input', () => {
                    if (input.value === '') {
                        input.setCustomValidity('');
                        return;
                    }

                    const parsed = Number.parseInt(input.value, 10);
                    if (Number.isNaN(parsed)) {
                        input.setCustomValidity('Enter a whole number');
                    } else {
                        input.value = parsed;
                        input.setCustomValidity('');
                    }
                });

                return input;
            }

            function createSetRow(exerciseName, setIndex, block, draft) {
                const row = document.createElement('div');
                row.className = 'set-row';

                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.inputMode = 'decimal';
                weightInput.step = '0.5';
                weightInput.placeholder = 'Weight';
                weightInput.dataset.exerciseName = exerciseName;
                weightInput.dataset.setIndex = setIndex;
                weightInput.dataset.field = 'weight';

                const prev = findPreviousExercise(exerciseName);
                const prevSet = prev && prev.sets[setIndex];
                const draftExercise = draft?.exercise_blocks?.find((ex) => ex.exercise_name === exerciseName);
                const draftSet = draftExercise?.sets?.[setIndex];

                let repsField = null;
                if (block.amrap) {
                    const initial = draftSet?.reps ?? prevSet?.reps;
                    repsField = createAmrapInput(exerciseName, setIndex, initial);
                } else {
                    const repsSelect = document.createElement('select');
                    repsSelect.dataset.exerciseName = exerciseName;
                    repsSelect.dataset.setIndex = setIndex;
                    repsSelect.dataset.field = 'reps';
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Reps';
                    repsSelect.appendChild(placeholder);
                    repOptions(block).forEach((rep) => {
                        const option = document.createElement('option');
                        option.value = rep;
                        option.textContent = rep;
                        repsSelect.appendChild(option);
                    });
                    repsField = repsSelect;
                }

                if (draftSet) {
                    weightInput.value = draftSet.weight ?? '';
                    if (!block.amrap) {
                        repsField.value = draftSet.reps ?? '';
                    } else if (Number.isInteger(draftSet.reps)) {
                        repsField.value = draftSet.reps;
                    }
                } else if (prevSet) {
                    weightInput.value = prevSet.weight ?? '';
                    if (!block.amrap) {
                        repsField.value = prevSet.reps ?? '';
                    } else if (Number.isInteger(prevSet.reps)) {
                        repsField.value = prevSet.reps;
                    }
                }

                const repsLabel = document.createElement('label');
                repsLabel.textContent = `Set ${setIndex + 1} reps`;
                repsLabel.appendChild(repsField);

                const weightLabel = document.createElement('label');
                weightLabel.textContent = `Set ${setIndex + 1} weight`;
                weightLabel.appendChild(weightInput);

                row.appendChild(weightLabel);
                row.appendChild(repsLabel);
                return row;
            }

            function renderExercise(block, draft) {
                const details = document.createElement('details');
                details.className = 'exercise-card';
                details.open = true;

                const summary = document.createElement('summary');
                summary.innerHTML = `
                    <div>
                        <div>${block.exercise_name}</div>
                        <div class="exercise-meta">${block.sets} sets${block.amrap ? ' ¬∑ AMRAP' : ''}${block.notes ? ` ¬∑ ${block.notes}` : ''}</div>
                    </div>
                `;

                const previousChip = renderPreviousChip(block);
                if (previousChip) {
                    const chipRow = document.createElement('div');
                    chipRow.className = 'chip-row';
                    chipRow.appendChild(previousChip);
                    summary.appendChild(chipRow);
                }

                const body = document.createElement('div');
                body.className = 'exercise-body';
                const setsGrid = document.createElement('div');
                setsGrid.className = 'stack';

                for (let i = 0; i < block.sets; i += 1) {
                    setsGrid.appendChild(createSetRow(block.exercise_name, i, block, draft));
                }

                const progressionLabel = document.createElement('label');
                progressionLabel.textContent = 'Progression notes';
                const progressionNotes = document.createElement('textarea');
                progressionNotes.placeholder = 'Cues, tempo, next time‚Ä¶';
                progressionNotes.dataset.exerciseName = block.exercise_name;
                progressionNotes.dataset.field = 'notes';

                const draftExercise = draft?.exercise_blocks?.find((ex) => ex.exercise_name === block.exercise_name);
                if (draftExercise) {
                    progressionNotes.value = draftExercise.notes || '';
                }

                const rpeLabel = document.createElement('label');
                rpeLabel.textContent = 'RIR (reps in reserve, optional)';
                const rpeInput = document.createElement('input');
                rpeInput.type = 'number';
                rpeInput.step = '1';
                rpeInput.min = '0';
                rpeInput.placeholder = 'e.g. 2';
                rpeInput.dataset.exerciseName = block.exercise_name;
                rpeInput.dataset.field = 'rpe';
                if (draftExercise && draftExercise.rpe_reserve !== undefined) {
                    rpeInput.value = draftExercise.rpe_reserve;
                }

                progressionLabel.appendChild(progressionNotes);
                rpeLabel.appendChild(rpeInput);

                body.appendChild(setsGrid);
                body.appendChild(progressionLabel);
                body.appendChild(rpeLabel);

                details.appendChild(summary);
                details.appendChild(body);
                return details;
            }

            function loadDraftIntoUI(template, draft, previousSession) {
                const prefill = draft || previousSession || null;
                elements.exerciseList.innerHTML = '';
                template.exercise_blocks.forEach((block) => {
                    elements.exerciseList.appendChild(renderExercise(block, prefill));
                });

                elements.workoutTitle.textContent = template.name;
                elements.workoutSummary.textContent = templateDescription(template);
                elements.workoutPanel.hidden = false;
                elements.saveStatus.textContent = '';
                elements.storageIndicator.textContent = 'Draft saved locally';

                const date = draft?.date || new Date().toISOString().slice(0, 10);
                elements.sessionDate.value = date;
                elements.overallNotes.value = draft?.notes || '';
            }

            async function loadTemplateDetails(name) {
                elements.templateStatus.textContent = 'Loading template‚Ä¶';
                elements.exerciseList.innerHTML = '';
                elements.workoutPanel.hidden = true;
                state.latestSession = null;

                try {
                    const template = await callApi(`/templates/${encodeURIComponent(name)}`);
                    state.selectedTemplate = template;
                    elements.workoutHint.textContent = 'Fill the sets and submit when done.';
                    const draft = getDraft(name);
                    let lastSession = null;

                    try {
                        const latest = await callApi(`/templates/${encodeURIComponent(name)}/sessions?limit=1`);
                        lastSession = latest.sessions?.[0] || null;
                        state.latestSession = lastSession;
                        if (lastSession) {
                            elements.lastSessionStatus.textContent = `Last session on ${lastSession.date}. Prefilled with previous numbers.`;
                        } else {
                            elements.lastSessionStatus.textContent = 'No previous sessions logged yet.';
                        }
                    } catch (error) {
                        elements.lastSessionStatus.textContent = `Could not load last session: ${error.message}`;
                    }

                    loadDraftIntoUI(template, draft, lastSession);
                    elements.templateStatus.textContent = '';
                    scheduleDraftSave();
                } catch (error) {
                    elements.templateStatus.textContent = error.message;
                }
            }

            function buildCurrentPayload() {
                if (!state.selectedTemplate) return null;
                const exercise_blocks = state.selectedTemplate.exercise_blocks.map((block) => {
                    const sets = [];
                    for (let i = 0; i < block.sets; i += 1) {
                        const weight = document.querySelector(`input[data-exercise-name="${block.exercise_name}"][data-set-index="${i}"][data-field="weight"]`);
                        const reps = document.querySelector(`[data-exercise-name="${block.exercise_name}"][data-set-index="${i}"][data-field="reps"]`);
                        sets.push({
                            weight: weight?.value ? Number(weight.value) : 0,
                            reps: reps?.value ? Number.parseInt(reps.value, 10) : 0,
                        });
                    }
                    const notes = document.querySelector(`textarea[data-exercise-name="${block.exercise_name}"][data-field="notes"]`)?.value || '';
                    const rpeValue = document.querySelector(`input[data-exercise-name="${block.exercise_name}"][data-field="rpe"]`)?.value;
                    return {
                        exercise_name: block.exercise_name,
                        notes,
                        rpe_reserve: rpeValue !== '' && rpeValue !== undefined ? Number(rpeValue) : undefined,
                        sets,
                    };
                });

                return {
                    template_name: state.selectedTemplate.name,
                    date: elements.sessionDate.value || new Date().toISOString().slice(0, 10),
                    notes: elements.overallNotes.value || '',
                    exercise_blocks,
                };
            }

            function scheduleDraftSave() {
                if (!state.selectedTemplate) return;
                window.clearTimeout(state.autosaveTimer);
                state.autosaveTimer = window.setTimeout(() => {
                    const payload = buildCurrentPayload();
                    if (payload) {
                        persistDraft(state.selectedTemplate.name, payload);
                        elements.saveStatus.textContent = 'Saved locally.';
                    }
                }, 350);
            }

            async function handleTemplateChange() {
                const name = elements.templateSelect.value;
                state.latestSession = null;
                if (!name) {
                    state.selectedTemplate = null;
                    elements.workoutPanel.hidden = true;
                    return;
                }
                await loadTemplateDetails(name);
            }

            async function submitWorkout() {
                if (!state.selectedTemplate) return;
                elements.saveStatus.textContent = 'Submitting‚Ä¶';
                const payload = buildCurrentPayload();
                if (!payload) return;

                try {
                    await callApi('/sessions', {
                        method: 'POST',
                        body: JSON.stringify(payload),
                    });
                    clearDraft(state.selectedTemplate.name);
                    elements.saveStatus.textContent = 'Workout submitted and stored. Draft cleared.';
                } catch (error) {
                    elements.saveStatus.textContent = `Submit failed: ${error.message}`;
                }
            }

            function bindEvents() {
                elements.refreshTemplates.addEventListener('click', refreshTemplates);
                elements.templateSelect.addEventListener('change', handleTemplateChange);
                elements.submitWorkout.addEventListener('click', submitWorkout);
                elements.workoutPanel.addEventListener('input', scheduleDraftSave, true);
                elements.workoutPanel.addEventListener('change', scheduleDraftSave, true);
            }

            function init() {
                bindEvents();
                refreshTemplates();
            }

            init();
        })();
    </script>

    <footer class="page-footer">
        <p>Built with ‚ù§Ô∏è, ü§ñ, and üêç, by <a href="https://mathspp.com/">Rodrigo Gir√£o Serr√£o</a></p>
    </footer>
</body>

</html>
