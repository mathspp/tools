<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What time is it for me?</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 20px 48px;
        }

        main {
            display: grid;
            gap: 1.5rem;
        }

        .tool-card {
            padding: clamp(1.25rem, 3vw, 2rem);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .shared-label {
            margin: 0 0 0.5rem;
            font-size: 1rem;
            color: var(--text-muted);
        }

        .shared-target {
            margin: 0;
            font-size: clamp(1.4rem, 4vw, 2.4rem);
            font-weight: 700;
        }

        .zone-note {
            color: var(--text-muted);
            margin-top: 0.35rem;
            font-size: 0.95rem;
        }

        .inline-fields {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .tool-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .status-message {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .inline-field {
            display: flex;
            flex-direction: column;
        }

        .comparison-table {
            margin-top: 1rem;
        }

        .comparison-table[hidden] {
            display: none;
        }

        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--surface-border, rgba(0, 0, 0, 0.08));
            vertical-align: top;
        }

        .comparison-table th {
            text-align: left;
        }

        .comparison-label {
            font-weight: 600;
        }

        .comparison-zone {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            word-break: break-word;
        }

        .comparison-select-wrapper select {
            width: 100%;
        }

        .comparison-controls {
            margin-top: 0.75rem;
        }

        .comparison-actions-header {
            width: 1%;
        }

        .comparison-actions-cell {
            text-align: right;
        }

        .link-button {
            background: none;
            border: none;
            color: var(--link-color, var(--accent-color, #0051ff));
            cursor: pointer;
            padding: 0;
            font: inherit;
            text-decoration: underline;
        }

        .link-button:hover,
        .link-button:focus {
            text-decoration: none;
        }

        .comparison-empty {
            margin: 0;
            color: var(--text-muted);
        }

        @media (max-width: 720px) {
            body {
                padding: 20px 16px 40px;
            }
        }
    </style>
</head>

<body>
    <header class="page-header">
        <a class="site-link" href="https://tools.mathspp.com/" aria-label="Back to tools.mathspp.com">‚Üê tools.mathspp.com</a>
        <h1>What time is it for me?</h1>
        <p class="lead">Pick a date, time, and timezone to create a shareable link that shows what that moment looks
            like from your timezone.</p>
    </header>

    <main>
        <section id="shared-moment-card" class="surface tool-card" aria-live="polite" hidden>
            <div class="card-header">
                <h2>Shared moment</h2>
                <span class="pill" id="shared-origin">From a shared link</span>
            </div>
            <p class="shared-label" id="shared-source"></p>
            <p class="shared-target" id="shared-target"></p>
        </section>

        <section class="surface tool-card" aria-live="polite" aria-label="Base timezone">
            <div class="card-header">
                <h2>Base timezone</h2>
                <span class="zone-note" id="timezone-source-note"></span>
            </div>
            <p>Your detected time zone: <strong id="inferred-timezone-value">Detecting‚Ä¶</strong></p>
            <div class="form-group">
                <label for="base-timezone-select">Change base time zone</label>
                <select id="base-timezone-select" name="base-timezone"></select>
            </div>
        </section>
        <section class="surface tool-card" aria-labelledby="selection-heading">
            <h2 id="selection-heading">Pick a moment</h2>
            <form id="moment-form">
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="datetime-input">Date and time</label>
                        <input id="datetime-input" name="datetime" type="datetime-local" required>
                    </div>
                    <div class="form-group">
                        <label for="timezone-select">Timezone</label>
                        <select id="timezone-select" name="timezone" required>
                        </select>
                    </div>
                </div>
                <div class="tool-actions">
                    <button type="button" id="copy-link-button">Copy link with this moment</button>
                    <span class="status-message" id="copy-status" role="status" aria-live="polite"></span>
                </div>
            </form>
        </section>

        <section class="surface tool-card" aria-live="polite" aria-labelledby="comparison-heading">
            <div class="card-header">
                <h2 id="comparison-heading">Preview across time zones</h2>
                <p class="comparison-empty" id="comparison-hint">Add time zones to see how this moment appears elsewhere.</p>
            </div>
            <p id="comparison-output" class="lead">Choose a date, time, and timezone to see how it translates to your
                current timezone.</p>
            <div class="comparison-controls">
                <button type="button" id="add-comparison-row">Add timezone to preview</button>
            </div>
            <div id="comparison-table" class="comparison-table" hidden>
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Timezone</th>
                            <th scope="col">Local time</th>
                            <th scope="col" class="comparison-actions-header" aria-label="Actions"></th>
                        </tr>
                    </thead>
                    <tbody id="comparison-rows"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"></script>

    <script>
        (function () {
            const { DateTime } = luxon;
            const datetimeInput = document.getElementById('datetime-input');
            const timezoneSelect = document.getElementById('timezone-select');
            const comparisonOutput = document.getElementById('comparison-output');
            const comparisonTable = document.getElementById('comparison-table');
            const comparisonRowsContainer = document.getElementById('comparison-rows');
            const addComparisonRowButton = document.getElementById('add-comparison-row');
            const copyButton = document.getElementById('copy-link-button');
            const copyStatus = document.getElementById('copy-status');
            const inferredTimezoneValue = document.getElementById('inferred-timezone-value');
            const baseTimezoneSelect = document.getElementById('base-timezone-select');
            const timezoneSourceNote = document.getElementById('timezone-source-note');
            const sharedMomentCard = document.getElementById('shared-moment-card');
            const sharedSource = document.getElementById('shared-source');
            const sharedTarget = document.getElementById('shared-target');
            const sharedOrigin = document.getElementById('shared-origin');
            const comparisonHint = document.getElementById('comparison-hint');

            const resolvedZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const fallbackZone = resolvedZone || DateTime.local().zoneName || 'UTC';
            let baseZone = fallbackZone;
            let timezoneManuallySet = false;
            const comparisonRows = [];
            let sharedMoment = null;

            function ensureOptionForZone(zone) {
                const exists = Array.from(timezoneSelect.options).some(option => option.value === zone);
                if (!exists && zone) {
                    const option = document.createElement('option');
                    option.value = zone;
                    option.textContent = zone;
                    timezoneSelect.append(option.cloneNode(true));
                    baseTimezoneSelect.append(option);
                }
            }

            function populateTimezones() {
                let zones = [];
                if (typeof Intl.supportedValuesOf === 'function') {
                    try {
                        zones = Intl.supportedValuesOf('timeZone');
                    } catch (error) {
                        // Ignore and fall back
                    }
                }

                if (!zones.length) {
                    zones = [
                        'UTC', 'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Europe/Madrid',
                        'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
                        'Asia/Tokyo', 'Asia/Shanghai', 'Asia/Kolkata', 'Australia/Sydney'
                    ];
                }

                for (const zone of zones) {
                    const option = document.createElement('option');
                    option.value = zone;
                    option.textContent = zone;
                    timezoneSelect.append(option.cloneNode(true));
                    baseTimezoneSelect.append(option);
                }

                ensureOptionForZone(baseZone);
            }

            function createTimezoneSelectElement() {
                const select = document.createElement('select');
                select.className = 'comparison-timezone-select';
                select.innerHTML = timezoneSelect.innerHTML;
                return select;
            }

            function updateInferredTimezoneDisplay(zone) {
                inferredTimezoneValue.textContent = zone || 'Unavailable';
            }

            function addCustomComparisonRow(initialZone) {
                ensureOptionForZone(initialZone);
                const row = document.createElement('tr');
                row.className = 'comparison-row comparison-row-custom';

                const labelCell = document.createElement('th');
                labelCell.scope = 'row';
                const select = createTimezoneSelectElement();
                select.value = initialZone;
                if (initialZone && select.value !== initialZone) {
                    const option = document.createElement('option');
                    option.value = initialZone;
                    option.textContent = initialZone;
                    select.append(option);
                    select.value = initialZone;
                }
                const selectWrapper = document.createElement('div');
                selectWrapper.className = 'comparison-select-wrapper';
                selectWrapper.append(select);
                labelCell.append(selectWrapper);

                const timeCell = document.createElement('td');
                timeCell.className = 'comparison-time';

                const actionCell = document.createElement('td');
                actionCell.className = 'comparison-actions-cell';
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'link-button';
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => {
                    row.remove();
                    const index = comparisonRows.findIndex(entry => entry.row === row);
                    if (index >= 0) {
                        comparisonRows.splice(index, 1);
                    }
                    updateComparison(true);
                });
                actionCell.append(removeButton);

                row.append(labelCell, timeCell, actionCell);
                comparisonRowsContainer.append(row);

                const entry = {
                    row,
                    getZone: () => select.value,
                    timeCell
                };
                comparisonRows.push(entry);

                select.addEventListener('change', () => updateComparison());
                return row;
            }

            function updateBaseZone(zone, note = '', { updateSelect = true, updateComparison: shouldUpdateComparison = true } = {}) {
                if (!zone) {
                    updateInferredTimezoneDisplay('Unavailable');
                    return;
                }

                const previousZone = baseZone;
                const zoneChanged = zone !== baseZone;
                baseZone = zone;
                updateInferredTimezoneDisplay(zone);
                timezoneSourceNote.textContent = note || '';
                ensureOptionForZone(zone);

                if (updateSelect) {
                    baseTimezoneSelect.value = zone;
                }

                if (updateSelect && !timezoneManuallySet && (timezoneSelect.value === previousZone || !timezoneSelect.value)) {
                    timezoneSelect.value = zone;
                }

                if (zoneChanged) {
                    updateSharedMomentCard();
                }

                if (shouldUpdateComparison && (zoneChanged || !comparisonTable.hidden)) {
                    updateComparison();
                }
            }

            function formatOffset(minutes) {
                const sign = minutes >= 0 ? '+' : '-';
                const absolute = Math.abs(minutes);
                const hours = String(Math.floor(absolute / 60)).padStart(2, '0');
                const mins = String(absolute % 60).padStart(2, '0');
                return `UTC${sign}${hours}:${mins}`;
            }

            function formatDateTime(dt) {
                const dayNumber = Number(dt.toFormat('d'));
                const suffix = (function (n) {
                    const tens = n % 100;
                    if (tens >= 11 && tens <= 13) {
                        return 'th';
                    }
                    switch (n % 10) {
                        case 1: return 'st';
                        case 2: return 'nd';
                        case 3: return 'rd';
                        default: return 'th';
                    }
                })(dayNumber);

                const formattedDate = dt.toFormat(`d'${suffix}' MMMM yyyy`);
                const formattedTime = dt.toFormat('h:mm a');
                return `${formattedDate}, ${formattedTime}`;
            }

            function buildShareableUrl(dt) {
                if (!dt || !dt.isValid) {
                    return location.href;
                }
                const url = new URL(location.href);
                url.searchParams.set('date', dt.toFormat('yyyy-LL-dd'));
                url.searchParams.set('time', dt.toFormat('HH:mm'));
                url.searchParams.set('timezone', dt.zoneName);
                return url.toString();
            }

            function updateComparison(fromUrl = false) {
                const datetimeValue = datetimeInput.value;
                const selectedZone = timezoneSelect.value;

                if (!datetimeValue || !selectedZone) {
                    comparisonOutput.textContent = 'Choose a date, time, and timezone to see how it translates to your current timezone.';
                    comparisonTable.hidden = comparisonRows.length === 0;
                    comparisonHint.hidden = comparisonRows.length > 0;
                    return;
                }

                const momentInSelectedZone = DateTime.fromISO(datetimeValue, { zone: selectedZone });

                if (!momentInSelectedZone.isValid) {
                    comparisonOutput.textContent = 'The selected date or timezone could not be parsed. Please check your inputs.';
                    comparisonTable.hidden = comparisonRows.length === 0;
                    comparisonHint.hidden = comparisonRows.length > 0;
                    return;
                }

                const selectedOffset = formatOffset(momentInSelectedZone.offset);

                const sourceText = `${formatDateTime(momentInSelectedZone)} in ${momentInSelectedZone.zoneName} (${selectedOffset})`;
                comparisonOutput.textContent = `${sourceText}. Here's how that moment translates across the selected timezones:`;
                comparisonTable.hidden = comparisonRows.length === 0;
                comparisonHint.hidden = comparisonRows.length > 0;

                for (const entry of comparisonRows) {
                    const zoneName = entry.getZone();
                    if (!zoneName) {
                        entry.timeCell.textContent = 'Pick a timezone to see the converted time.';
                        continue;
                    }

                    const zoned = momentInSelectedZone.setZone(zoneName);
                    if (!zoned.isValid) {
                        entry.timeCell.textContent = 'Unable to resolve that timezone.';
                        continue;
                    }

                    entry.timeCell.textContent = `${formatDateTime(zoned)} (${formatOffset(zoned.offset)})`;
                }

                copyStatus.textContent = '';

                if (!fromUrl) {
                    const url = new URL(location.href);
                    url.searchParams.set('date', momentInSelectedZone.toFormat('yyyy-LL-dd'));
                    url.searchParams.set('time', momentInSelectedZone.toFormat('HH:mm'));
                    url.searchParams.set('timezone', momentInSelectedZone.zoneName);
                    window.history.replaceState({}, '', url);
                }
            }

            async function copyLink() {
                const datetimeValue = datetimeInput.value;
                const selectedZone = timezoneSelect.value;

                if (!datetimeValue || !selectedZone) {
                    copyStatus.textContent = 'Select a date, time, and timezone first.';
                    return;
                }

                const momentInSelectedZone = DateTime.fromISO(datetimeValue, { zone: selectedZone });
                if (!momentInSelectedZone.isValid) {
                    copyStatus.textContent = 'Unable to copy‚Äîplease check the selected date and timezone.';
                    return;
                }

                const shareUrl = buildShareableUrl(momentInSelectedZone);

                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(shareUrl);
                    } else {
                        const textarea = document.createElement('textarea');
                        textarea.value = shareUrl;
                        textarea.setAttribute('readonly', '');
                        textarea.style.position = 'absolute';
                        textarea.style.left = '-9999px';
                        document.body.append(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        textarea.remove();
                    }
                    copyStatus.textContent = 'Link copied to clipboard!';
                } catch (error) {
                    copyStatus.textContent = 'Copy failed‚Äîselect and copy the link manually.';
                }
            }

            function applyQueryParameters() {
                const params = new URLSearchParams(window.location.search);
                const dateParam = params.get('date');
                const timeParam = params.get('time');
                const timezoneParam = params.get('timezone');

                if (dateParam && timeParam) {
                    const combined = `${dateParam}T${timeParam}`;
                    datetimeInput.value = combined;
                }

                if (dateParam && timeParam && timezoneParam) {
                    sharedMoment = DateTime.fromISO(`${dateParam}T${timeParam}`, { zone: timezoneParam });
                }

                if (dateParam && timeParam) {
                    sharedOrigin.textContent = 'Loaded from URL parameters';
                }

                if (timezoneParam) {
                    ensureOptionForZone(timezoneParam);
                    timezoneSelect.value = timezoneParam;
                    timezoneManuallySet = true;
                }

                if (datetimeInput.value && timezoneSelect.value) {
                    updateComparison(true);
                }

                updateSharedMomentCard();
            }

            async function detectTimezoneFromIp() {
                let detectedZone = null;
                try {
                    const response = await fetch('https://worldtimeapi.org/api/ip');
                    if (response.ok) {
                        const data = await response.json();
                        if (data && typeof data.timezone === 'string' && data.timezone) {
                            detectedZone = data.timezone;
                        }
                    }
                } catch (error) {
                    // Ignore network or parsing issues and fall back to browser detection
                }

                if (detectedZone) {
                    updateBaseZone(detectedZone, 'Inferred from your IP address (worldtimeapi.org).');
                } else {
                    updateBaseZone(fallbackZone, 'Using your browser-reported time zone.', { updateSelect: false, updateComparison: false });
                }
            }

            function updateSharedMomentCard() {
                if (!sharedMoment || !sharedMoment.isValid) {
                    sharedMomentCard.hidden = true;
                    return;
                }

                const baseZoneMoment = sharedMoment.setZone(baseZone);
                const sourceLine = `${sharedMoment.toFormat('HH:mm')} on the ${sharedMoment.toFormat('dd')} of ${sharedMoment.toFormat('LL')}, ${sharedMoment.toFormat('yyyy')} ${sharedMoment.zoneName} is`;
                sharedSource.textContent = sourceLine;
                sharedTarget.textContent = baseZoneMoment.isValid ? `${baseZoneMoment.toFormat('HH:mm')} on ${baseZoneMoment.toFormat('dd LLL yyyy')} (${baseZoneMoment.offsetNameShort})` : 'Unable to convert to your base time zone.';
                sharedMomentCard.hidden = false;
            }

            populateTimezones();
            timezoneSelect.value = baseZone;
            baseTimezoneSelect.value = baseZone;
            datetimeInput.value = DateTime.now().toISO({ suppressSeconds: true, suppressMilliseconds: true }).slice(0, 16);
            updateComparison(true);

            applyQueryParameters();
            detectTimezoneFromIp();

            datetimeInput.addEventListener('input', () => updateComparison());
            datetimeInput.addEventListener('change', () => updateComparison());
            timezoneSelect.addEventListener('change', () => {
                timezoneManuallySet = true;
                updateComparison();
            });
            baseTimezoneSelect.addEventListener('change', () => {
                updateBaseZone(baseTimezoneSelect.value, 'Manually selected base time zone.');
            });
            copyButton.addEventListener('click', copyLink);
            addComparisonRowButton.addEventListener('click', () => {
                const defaultZone = timezoneSelect.value || baseZone;
                addCustomComparisonRow(defaultZone);
                updateComparison();
            });
        })();
    </script>

    <footer class="page-footer">
        <p>Built with ‚ù§Ô∏è, ü§ñ, and üêç, by <a href="https://mathspp.com/">Rodrigo Gir√£o Serr√£o</a></p>
    </footer>
</body>

</html>
